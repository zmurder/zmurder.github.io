<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8693861384618000"
     crossorigin="anonymous"></script>
  <meta name="msvalidate.01" content="7EC20DBC74B004C2782077570E15C280">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8693861384618000"
     crossorigin="anonymous"></script>
    <meta name="description" content="ç›®å½•  æ³¨æ„äº‹é¡¹ ä¸€ã€2023&#x2F;11&#x2F;5æ›´æ–° å‰è¨€ 1. YOLOv7-PTQé‡åŒ–æµç¨‹ 2. å‡†å¤‡å·¥ä½œ 3. æ’å…¥QDQèŠ‚ç‚¹  3.1 è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹ 3.2 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹ 3.3 æ‰‹åŠ¨initialize   æ€»ç»“">
<meta property="og:type" content="article">
<meta property="og:title" content="TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€)">
<meta property="og:url" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/index.html">
<meta property="og:site_name" content="å¥”è·‘çš„IC">
<meta property="og:description" content="ç›®å½•  æ³¨æ„äº‹é¡¹ ä¸€ã€2023&#x2F;11&#x2F;5æ›´æ–° å‰è¨€ 1. YOLOv7-PTQé‡åŒ–æµç¨‹ 2. å‡†å¤‡å·¥ä½œ 3. æ’å…¥QDQèŠ‚ç‚¹  3.1 è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹ 3.2 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹ 3.3 æ‰‹åŠ¨initialize   æ€»ç»“">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/3ac8e54d0077179cfb351dafc2574475.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/58b081510492e028789108b8fcb87d42.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/075ea1a990307b383f44c3dd7ea2304e.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/e130471d29babd681626fb5413ac083f.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/d06c38807b1aaa233e9d24c9cbd5e86a.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/d266ac5e9fe31c1b7912b94edc202afb.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/a2e73bee11aec11e9558c33f98da3d88.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/835dc14ca12e4382ef1d6173038e9d7a.png">
<meta property="og:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/d38812303c139eff477729e0a7c2c95f.png">
<meta property="article:published_time" content="2024-12-01T10:13:45.541Z">
<meta property="article:modified_time" content="2024-12-01T10:13:45.542Z">
<meta property="article:author" content="å¥”è·‘çš„IC">
<meta property="article:tag" content="C">
<meta property="article:tag" content="Tensorrt">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/3ac8e54d0077179cfb351dafc2574475.png">


<link rel="canonical" href="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/","path":"TensorRT/TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€)/","title":"TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€) | å¥”è·‘çš„IC</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">å¥”è·‘çš„IC</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-reorder fa-fw"></i>æ–‡ç« åˆ—è¡¨</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-text">ç›®å½•</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">æ³¨æ„äº‹é¡¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%812023-11-5%E6%9B%B4%E6%96%B0"><span class="nav-text">ä¸€ã€2023&#x2F;11&#x2F;5æ›´æ–°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-YOLOv7-PTQ%E9%87%8F%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="nav-text">1. YOLOv7-PTQé‡åŒ–æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">1. å‡†å¤‡å·¥ä½œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%8F%92%E5%85%A5-QDQ-%E8%8A%82%E7%82%B9"><span class="nav-text">2. æ’å…¥ QDQ èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%A0%87%E5%AE%9A"><span class="nav-text">3. æ ‡å®š</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%95%8F%E6%84%9F%E5%B1%82%E5%88%86%E6%9E%90"><span class="nav-text">4. æ•æ„Ÿå±‚åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%AF%BC%E5%87%BA-PTQ-%E6%A8%A1%E5%9E%8B"><span class="nav-text">5. å¯¼å‡º PTQ æ¨¡å‹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">2. å‡†å¤‡å·¥ä½œ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E6%8F%92%E5%85%A5QDQ%E8%8A%82%E7%82%B9"><span class="nav-text">3. æ’å…¥QDQèŠ‚ç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E8%87%AA%E5%8A%A8%E6%8F%92%E5%85%A5QDQ%E8%8A%82%E7%82%B9"><span class="nav-text">3.1 è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%89%8B%E5%8A%A8%E6%8F%92%E5%85%A5QDQ%E8%8A%82%E7%82%B9"><span class="nav-text">3.2 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%89%8B%E5%8A%A8initialize"><span class="nav-text">3.3 æ‰‹åŠ¨initialize</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">æ€»ç»“</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="å¥”è·‘çš„IC"
      src="/images/zyd.gif">
  <p class="site-author-name" itemprop="name">å¥”è·‘çš„IC</p>
  <div class="site-description" itemprop="description">æ­»ç£•ç‰›è§’çš„ITå†œæ°‘å·¥</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">147</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zyd.gif">
      <meta itemprop="name" content="å¥”è·‘çš„IC">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="å¥”è·‘çš„IC">
      <meta itemprop="description" content="æ­»ç£•ç‰›è§’çš„ITå†œæ°‘å·¥">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€) | å¥”è·‘çš„IC">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-12-01 18:13:45" itemprop="dateCreated datePublished" datetime="2024-12-01T18:13:45+08:00">2024-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/TensorRT/" itemprop="url" rel="index"><span itemprop="name">TensorRT</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h1><ul>
<li><ul>
<li><a href="#_2">æ³¨æ„äº‹é¡¹</a></li>
<li><a href="#2023115_3">ä¸€ã€2023/11/5æ›´æ–°</a></li>
<li><a href="#_6">å‰è¨€</a></li>
<li><a href="#1_YOLOv7PTQ_19">1. YOLOv7-PTQé‡åŒ–æµç¨‹</a></li>
<li><a href="#2__69">2. å‡†å¤‡å·¥ä½œ</a></li>
<li><a href="#3_QDQ_306">3. æ’å…¥QDQèŠ‚ç‚¹</a></li>
<li><ul>
<li><a href="#31_QDQ_308">3.1 è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹</a></li>
<li><a href="#32_QDQ_630">3.2 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹</a></li>
<li><a href="#33_initialize_833">3.3 æ‰‹åŠ¨initialize</a></li>
</ul>
</li>
<li><a href="#_872">æ€»ç»“</a></li>
</ul>
</li>
</ul>
<h1 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h1><h3 id="ä¸€ã€2023-11-5æ›´æ–°"><a href="#ä¸€ã€2023-11-5æ›´æ–°" class="headerlink" title="ä¸€ã€2023/11/5æ›´æ–°"></a>ä¸€ã€2023/11/5æ›´æ–°</h3><p><strong>æ–°å¢æ‰‹åŠ¨æ’å…¥ QDQ èŠ‚ç‚¹ä»¥åŠæ‰‹åŠ¨ initialize</strong></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote>
<p>æ‰‹å†™ AI æ¨å‡ºçš„å…¨æ–° TensorRT <a target="_blank" rel="noopener" href="https://ml-summit.org/cloud-member?uid=c1041&amp;spm=1001.2101.3001.7020">æ¨¡å‹</a>é‡åŒ–å®æˆ˜è¯¾ç¨‹ï¼Œ<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1NN411b7HZ/?spm_id_from=333.999.0.0">é“¾æ¥</a>ã€‚è®°å½•ä¸‹ä¸ªäººå­¦ä¹ ç¬”è®°ï¼Œä»…ä¾›è‡ªå·±å‚è€ƒã€‚</p>
<p>è¯¥å®æˆ˜è¯¾ç¨‹ä¸»è¦åŸºäºæ‰‹å†™ AI çš„ Latte è€å¸ˆæ‰€å‡ºçš„ <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18L41197Uz/">TensorRTä¸‹çš„æ¨¡å‹é‡åŒ–</a>ï¼Œåœ¨å…¶è¯¾ç¨‹çš„åŸºç¡€ä¸Šï¼Œæ‰€æ•´ç†å‡ºçš„ä¸€äº›å®æˆ˜åº”ç”¨ã€‚</p>
<p>æœ¬æ¬¡è¯¾ç¨‹ä¸º YOLOv7 é‡åŒ–å®æˆ˜ç¬¬äºŒè¯¾ï¼Œä¸»è¦ä»‹ç» YOLOv7-PTQ é‡åŒ–</p>
<p>è¯¾ç¨‹å¤§çº²å¯çœ‹ä¸‹é¢çš„æ€ç»´å¯¼å›¾</p>
</blockquote>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/3ac8e54d0077179cfb351dafc2574475.png" class="" title="3ac8e54d0077179cfb351dafc2574475">
<h1 id="1-YOLOv7-PTQé‡åŒ–æµç¨‹"><a href="#1-YOLOv7-PTQé‡åŒ–æµç¨‹" class="headerlink" title="1. YOLOv7-PTQé‡åŒ–æµç¨‹"></a>1. YOLOv7-PTQé‡åŒ–æµç¨‹</h1><blockquote>
<p>åœ¨ä¸ŠèŠ‚è¯¾ç¨‹ä¸­æˆ‘ä»¬ä»‹ç»äº† pytorch_quantization é‡åŒ–å·¥å…·ç®±ï¼Œä»è¿™èŠ‚è¯¾å¼€å§‹æˆ‘ä»¬å°†æ­£å¼è¿›å…¥ YOLOv7-PTQ é‡åŒ–çš„å®æˆ˜ã€‚</p>
<p>ä»ä¸Šé¢çš„æ€ç»´å¯¼å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ° YOLOv7-PTQ é‡åŒ–çš„æ­¥éª¤ï¼Œæˆ‘ä»¬ä»£ç çš„è®²è§£å’Œç¼–å†™éƒ½æ˜¯æŒ‰ç…§è¿™ä¸ªæµç¨‹æ¥çš„ã€‚</p>
</blockquote>
<p>åœ¨ç¼–å†™ä»£ç å¼€å§‹ä¹‹å‰æˆ‘ä»¬è¿˜æ˜¯å†æ¥æ¢³ç†ä¸‹æ•´ä¸ª YOLOv7-PTQ é‡åŒ–çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p>
<h2 id="1-å‡†å¤‡å·¥ä½œ"><a href="#1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="1. å‡†å¤‡å·¥ä½œ"></a><strong>1.</strong> <strong>å‡†å¤‡å·¥ä½œ</strong></h2><p>é¦–å…ˆæ˜¯æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½ YOLOv7 å®˜æ–¹ä»£ç å’Œé¢„è®­ç»ƒæ¨¡å‹ä»¥åŠ COCO æ•°æ®é›†ï¼Œå¹¶ç¼–å†™ä»£ç å®Œæˆæ¨¡å‹å’Œæ•°æ®çš„åŠ è½½å·¥ä½œã€‚</p>
<h2 id="2-æ’å…¥-QDQ-èŠ‚ç‚¹"><a href="#2-æ’å…¥-QDQ-èŠ‚ç‚¹" class="headerlink" title="2. æ’å…¥ QDQ èŠ‚ç‚¹"></a><strong>2.</strong> <strong>æ’å…¥ QDQ èŠ‚ç‚¹</strong></h2><p>ç¬¬äºŒä¸ªå°±æ˜¯æˆ‘ä»¬éœ€è¦å¯¹æ¨¡å‹æ’å…¥ QDQ èŠ‚ç‚¹ï¼Œå®ƒæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li><strong>è‡ªåŠ¨æ’å…¥</strong><ul>
<li>ä½¿ç”¨ quant_modules.initialize() è‡ªåŠ¨æ’å…¥é‡åŒ–èŠ‚ç‚¹</li>
</ul>
</li>
<li><strong>æ‰‹åŠ¨æ’å…¥</strong><ul>
<li>ä½¿ç”¨ quant_modules.initialize() åˆå§‹åŒ–é‡åŒ–æ“ä½œæˆ–ä½¿ç”¨ QuantDescriptor() è‡ªå®šä¹‰åˆå§‹åŒ–é‡åŒ–æ“ä½œ</li>
<li>ç¼–å†™ä»£ç ä¸ºæ¨¡å‹æ’å…¥é‡åŒ–èŠ‚ç‚¹</li>
</ul>
</li>
</ul>
<h2 id="3-æ ‡å®š"><a href="#3-æ ‡å®š" class="headerlink" title="3. æ ‡å®š"></a><strong>3.</strong> <strong>æ ‡å®š</strong></h2><p>ç¬¬ä¸‰éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬çš„æ ‡å®šï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>1.</strong> é€šè¿‡å°†æ ‡å®šæ•°æ®é€åˆ°ç½‘ç»œå¹¶æ”¶é›†ç½‘ç»œæ¯ä¸ªå±‚çš„è¾“å…¥è¾“å‡ºä¿¡æ¯</li>
<li><strong>2.</strong> æ ¹æ®ç»Ÿè®¡å‡ºçš„ä¿¡æ¯ï¼Œè®¡ç®—åŠ¨æ€èŒƒå›´ range å’Œ scaleï¼Œå¹¶ä¿å­˜åœ¨ QDQ èŠ‚ç‚¹ä¸­</li>
</ul>
<h2 id="4-æ•æ„Ÿå±‚åˆ†æ"><a href="#4-æ•æ„Ÿå±‚åˆ†æ" class="headerlink" title="4. æ•æ„Ÿå±‚åˆ†æ"></a><strong>4.</strong> <strong>æ•æ„Ÿå±‚åˆ†æ</strong></h2><p>ç¬¬å››éƒ¨åˆ†æ˜¯æ•æ„Ÿå±‚åˆ†æï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>1.</strong> è¿›è¡Œå•ä¸€é€å±‚é‡åŒ–ï¼Œåªå¼€å¯æŸä¸€å±‚çš„é‡åŒ–å…¶ä»–å±‚éƒ½ä¸å¼€å¯</li>
<li><strong>2.</strong> åœ¨éªŒè¯é›†ä¸Šè¿›è¡Œæ¨¡å‹ç²¾åº¦æµ‹è¯•</li>
<li><strong>3.</strong> é€‰å‡ºå‰ 10 ä¸ªå¯¹æ¨¡å‹ç²¾åº¦å½±å“æ¯”è¾ƒå¤§çš„å±‚ï¼Œå…³é—­è¿™ 10 ä¸ªå±‚çš„é‡åŒ–ï¼Œåœ¨å‰å‘è®¡ç®—æ—¶ä½¿ç”¨ float16 è€Œä¸å»ä½¿ç”¨ int8</li>
</ul>
<h2 id="5-å¯¼å‡º-PTQ-æ¨¡å‹"><a href="#5-å¯¼å‡º-PTQ-æ¨¡å‹" class="headerlink" title="5. å¯¼å‡º PTQ æ¨¡å‹"></a><strong>5.</strong> <strong>å¯¼å‡º PTQ æ¨¡å‹</strong></h2><p>ç¬¬äº”ä¸ªå°±æ˜¯æˆ‘ä»¬åœ¨æ ‡å®šä¹‹åéœ€è¦å¯¼å‡º PTQ æ¨¡å‹ï¼Œå¯¼å‡ºæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>1.</strong> éœ€è¦å°†æˆ‘ä»¬ä¸ŠèŠ‚è¯¾æ‰€è¯´çš„ quant_nn.TensorQuantizer.use_fb_fake_quant å±æ€§è®¾ç½®ä¸º true</li>
<li><strong>2.</strong> torch.onnx.export() å¯¼å‡º ONNX æ¨¡å‹</li>
</ul>
<p><strong>6.</strong> <strong>æ€§èƒ½å¯¹æ¯”</strong></p>
<p>ç¬¬å…­ä¸ªå°±æ˜¯<a target="_blank" rel="noopener" href="https://marketing.csdn.net/p/3127db09a98e0723b83b2914d9256174?pId=2782?utm_source=glcblog&amp;spm=1001.2101.3001.7020">æ€§èƒ½</a>çš„å¯¹æ¯”ï¼ŒåŒ…æ‹¬ç²¾åº¦å’Œé€Ÿåº¦çš„å¯¹æ¯”ã€‚</p>
<p>OKï¼ä»¥ä¸Šå°±æ˜¯ YOLOv7-PTQ é‡åŒ–çš„æµç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„æµç¨‹æ¥å…·ä½“çš„å®ç°ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼ï¼ï¼ğŸš€ğŸš€ğŸš€</p>
<h1 id="2-å‡†å¤‡å·¥ä½œ"><a href="#2-å‡†å¤‡å·¥ä½œ" class="headerlink" title="2. å‡†å¤‡å·¥ä½œ"></a>2. å‡†å¤‡å·¥ä½œ</h1><p>é¦–å…ˆæ˜¯æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œï¼Œåœ¨æ­£å¼å¼€å§‹å‰æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸‰ä¸ªä¸œè¥¿ï¼š</p>
<ul>
<li><strong>ä»£ç </strong>ï¼šyolov7 å®˜æ–¹ä»£ç </li>
<li><strong>æ•°æ®é›†</strong>ï¼šcoco2017</li>
<li><strong>å®˜æ–¹é¢„è®­ç»ƒæ¨¡å‹</strong>ï¼šyolov7.pt</li>
</ul>
<p>å¤§å®¶å¯ä»¥ç‚¹å‡» <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1hXBxi9Sm_iW6nw5BFYxy-g">hereã€pwd:yoloã€‘</a> ä¸‹è½½åšä¸»å‡†å¤‡å¥½çš„ç›¸å…³ä»£ç ã€æ¨¡å‹å’Œæ•°æ®é›†</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹æˆ‘ä»¬æ•´ä¸ªé¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/58b081510492e028789108b8fcb87d42.png" class="" title="58b081510492e028789108b8fcb87d42">
<p>å…¶ä¸­çš„ coco2017 çš„æ•°æ®é›†ç›®å½•å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€train2017</span><br><span class="line">â”‚  â”œâ”€images</span><br><span class="line">â”‚  â”œâ”€labels</span><br><span class="line">â”‚  â””â”€xml</span><br><span class="line">â””â”€val2017</span><br><span class="line">    â”œâ”€images</span><br><span class="line">    â”œâ”€labels</span><br><span class="line">    â””â”€xml</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦ train2017.txt å’Œ val2017.txt ä¸¤ä¸ª TXT æ–‡ä»¶ï¼Œåˆ†åˆ«å­˜å‚¨ç€å¯¹åº”<a target="_blank" rel="noopener" href="https://ml-summit.org/cloud-member?uid=c1041&amp;spm=1001.2101.3001.7020">è®­ç»ƒé›†</a>å’ŒéªŒè¯é›†<strong>å›¾åƒçš„å®Œæ•´è·¯å¾„</strong>ï¼Œä»¥ä¸‹æ˜¯ç”Ÿæˆå¯¹åº” TXT çš„ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">save_dir  = <span class="string">&quot;/home/jarvis/Learn/Datasets/VOC_QAT&quot;</span></span><br><span class="line">train_dir = <span class="string">&quot;/home/jarvis/Learn/Datasets/VOC_QAT/images/train&quot;</span></span><br><span class="line">train_txt_path = os.path.join(save_dir, <span class="string">&quot;train2017.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(train_txt_path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(train_dir):</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">&quot;.jpg&quot;</span>) <span class="keyword">or</span> filename.endswith(<span class="string">&quot;.png&quot;</span>): <span class="comment"># æ·»åŠ ä½ çš„å›¾åƒæ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">            file_path = os.path.join(train_dir, filename)</span><br><span class="line">            f.write(file_path + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;train2017.txt has been created at <span class="subst">&#123;train_txt_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">val_dir = <span class="string">&quot;/home/jarvis/Learn/Datasets/VOC_QAT/images/val&quot;</span></span><br><span class="line">val_txt_path = os.path.join(save_dir, <span class="string">&quot;val2017.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(val_txt_path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(val_dir):</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">&quot;.jpg&quot;</span>) <span class="keyword">or</span> filename.endswith(<span class="string">&quot;.png&quot;</span>): <span class="comment"># æ·»åŠ ä½ çš„å›¾åƒæ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">            file_path = os.path.join(val_dir, filename)</span><br><span class="line">            f.write(file_path + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;val2017.txt has been created at <span class="subst">&#123;val_txt_path&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>ä½ éœ€è¦ä¿®æ”¹ä»¥ä¸‹å‡ é¡¹ï¼š</p>
<ul>
<li><strong>save_dir</strong>ï¼štxt æ–‡æ¡£ä¿å­˜çš„è·¯å¾„ï¼Œåº”è¯¥ä¸ train2017 å’Œ val2017 æ–‡ä»¶å¤¹åœ¨åŒä¸€çº§ç›®å½•</li>
<li><strong>train_dir</strong>ï¼šè®­ç»ƒé›†å›¾ç‰‡è·¯å¾„</li>
<li><strong>val_dir</strong>ï¼šéªŒè¯é›†å›¾ç‰‡è·¯å¾„</li>
</ul>
<p>å°†ä¸Šè¿°å·¥ä½œå®Œæˆåï¼Œä¸‹é¢æˆ‘ä»¬æ­£å¼å¼€å§‹ç¼–å†™ä»£ç ã€‚</p>
<p>æˆ‘ä»¬å°†æ•°æ®é›†å’Œæƒé‡æ–‡ä»¶éƒ½æ”¾åœ¨ YOLOv7-main æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶å…ˆæ–°å»ºä¸€ä¸ª <strong>ptq.py</strong> æ–‡ä»¶ï¼Œå…ˆå®Œæˆæ¨¡å‹å’Œæ•°æ®é›†åŠ è½½ä»¥åŠæ¨¡å‹ mAP æµ‹è¯•å·¥ä½œï¼Œä¸»è¦æ˜¯ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°çš„ç¼–å†™ï¼š</p>
<ul>
<li><strong>load_yolov7_model</strong>ï¼šåŠ è½½ YOLOv7 æ¨¡å‹æƒé‡</li>
<li><strong>prepare_dataset</strong>ï¼šåŠ è½½æ•°æ®</li>
<li><strong>evaluate_coco()</strong>ï¼šmAP æµ‹è¯•</li>
</ul>
<p>æˆ‘ä»¬å…ˆçœ‹æ¨¡å‹åŠ è½½å‡½æ•°çš„ç¼–å†™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_yolov7_model</span>(<span class="params">weight, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">    ckpt  = torch.load(weight, map_location=device)</span><br><span class="line">    model = Model(<span class="string">&quot;cfg/training/yolov7.yaml&quot;</span>, ch=<span class="number">3</span>, nc=<span class="number">80</span>).to(device)</span><br><span class="line">    state_dict = ckpt[<span class="string">&#x27;model&#x27;</span>].<span class="built_in">float</span>().state_dict()</span><br><span class="line">    model.load_state_dict(state_dict, strict=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡ torch åŠ è½½äº†é¢„è®­ç»ƒæƒé‡ï¼Œç„¶åé€šè¿‡ YOLOv7 å®˜æ–¹çš„ Model ç±»åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶é€šè¿‡ load_state_dict æ–¹æ³•å°†çŠ¶æ€å­—å…¸åŠ è½½åˆ°æ¨¡å‹ä¸­ï¼Œæœ€åè¿”å›æ¨¡å‹ã€‚å€¼å¾—å¤§å®¶æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä¼šå°†åŠ è½½çš„æ¨¡å‹æƒé‡è½¬æ¢ä¸ºå•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åŠ è½½çš„æƒé‡å¯èƒ½æ˜¯ float64ï¼Œä½†æ˜¯æˆ‘ä»¬æ¨¡å‹é€šå¸¸åœ¨å‰å‘çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å•ç²¾åº¦ float32 è¿›è¡Œçš„æ¨ç†ï¼Œæ‰€ä»¥è¿™è¾¹åšä¸€ä¸ªè½¬åŒ–ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹æ•°æ®é›†åŠ è½½å‡½æ•°çš„ç¼–å†™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_dataset</span>(<span class="params">cocodir, batch_size=<span class="number">4</span></span>):</span><br><span class="line">    dataloader = create_dataloader(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;cocodir&#125;</span>/val2017.txt&quot;</span>,</span><br><span class="line">        imgsz=<span class="number">640</span>,</span><br><span class="line">        batch_size=batch_size,</span><br><span class="line">        opt=collections.namedtuple(<span class="string">&quot;Opt&quot;</span>, <span class="string">&quot;single_cls&quot;</span>)(<span class="literal">False</span>),</span><br><span class="line">        augment=<span class="literal">False</span>, hyp=<span class="literal">None</span>, rect=<span class="literal">True</span>, cache=<span class="literal">False</span>, stride=<span class="number">32</span>, pad=<span class="number">0.5</span>, image_weights=<span class="literal">False</span></span><br><span class="line">    )[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> dataloader</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ YOLOv7 å®˜æ–¹æä¾›çš„æ•°æ®åŠ è½½å™¨å‡½æ•° create_dataloader å®Œæˆæ•°æ®åŠ è½½ï¼Œæˆ‘ä»¬å°†å¯¹åº”çš„å‚æ•°å¡«å…¥å³å¯ï¼Œå…¶ä¸­çš„ opt å‚æ•°æ˜¯ç”¨æ¥æŒ‡å®šå½“å‰æ•°æ®é›†æ˜¯å¦ä¸ºå•ç±»åˆ«æ•°æ®é›†ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ COCO æ•°æ®é›†ï¼Œå…¶ä¸­åŒ…å« 80 ä¸ªç±»åˆ«ï¼Œæˆ‘ä»¬åº”è¯¥è®¾ç½®ä¸º Falseã€‚</p>
<p>åœ¨ä»£ç ä¸­æˆ‘ä»¬æ˜¯ä½¿ç”¨ python çš„ <strong>collections.namedtuple</strong> å‡½æ•°å®ä¾‹åŒ–äº†ä¸€ä¸ªåä¸º <strong>Opt</strong> çš„å‘½åå…ƒç»„ç±»ï¼Œå®ƒæœ‰ä¸€ä¸ªå­—æ®µ <strong>single_cls</strong>ï¼Œå…¶è¢«è®¾ç½®ä¸º <strong>False</strong>ï¼Œé‚£å…¶å®å°±ç›¸å½“äº <strong>opt.single_cls = Flase</strong> å‚æ•°ä¼ é€’è¿›å»äº†ã€‚</p>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹éªŒè¯å‡½æ•°çš„ç¼–å†™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_coco</span>(<span class="params">model, loader, save_dir=<span class="string">&#x27;&#x27;</span>, conf_thres=<span class="number">0.001</span>, iou_thres=<span class="number">0.65</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> save_dir <span class="keyword">and</span> os.path.dirname(save_dir) != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        os.makedirs(os.path.dirname(save_dir), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> test.test(</span><br><span class="line">        <span class="string">&quot;data/coco.yaml&quot;</span>,</span><br><span class="line">        save_dir=Path(save_dir),</span><br><span class="line">        conf_thres=conf_thres,</span><br><span class="line">        iou_thres=iou_thres,</span><br><span class="line">        model=model,</span><br><span class="line">        dataloader=loader,</span><br><span class="line">        is_coco=<span class="literal">True</span>,</span><br><span class="line">        plots=<span class="literal">False</span>,</span><br><span class="line">        half_precision=<span class="literal">True</span>,</span><br><span class="line">        save_json=<span class="literal">False</span></span><br><span class="line">    )[<span class="number">0</span>][<span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ YOLOv7 å®˜æ–¹çš„ test å‡½æ•°ï¼Œå°†å¯¹åº”çš„å‚æ•°ä¼ é€’å³å¯ã€‚</p>
<p>å®Œæ•´çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> test</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> models.yolo <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> utils.datasets <span class="keyword">import</span> create_dataloader</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_yolov7_model</span>(<span class="params">weight, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">    ckpt  = torch.load(weight, map_location=device)</span><br><span class="line">    model = Model(<span class="string">&quot;cfg/training/yolov7.yaml&quot;</span>, ch=<span class="number">3</span>, nc=<span class="number">80</span>).to(device)</span><br><span class="line">    state_dict = ckpt[<span class="string">&#x27;model&#x27;</span>].<span class="built_in">float</span>().state_dict()</span><br><span class="line">    model.load_state_dict(state_dict, strict=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_dataset</span>(<span class="params">cocodir, batch_size=<span class="number">4</span></span>):</span><br><span class="line">    dataloader = create_dataloader(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;cocodir&#125;</span>/val2017.txt&quot;</span>,</span><br><span class="line">        imgsz=<span class="number">640</span>,</span><br><span class="line">        batch_size=batch_size,</span><br><span class="line">        opt=collections.namedtuple(<span class="string">&quot;Opt&quot;</span>, <span class="string">&quot;single_cls&quot;</span>)(<span class="literal">False</span>),</span><br><span class="line">        augment=<span class="literal">False</span>, hyp=<span class="literal">None</span>, rect=<span class="literal">True</span>, cache=<span class="literal">False</span>, stride=<span class="number">32</span>, pad=<span class="number">0.5</span>, image_weights=<span class="literal">False</span></span><br><span class="line">    )[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> dataloader</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_coco</span>(<span class="params">model, loader, save_dir=<span class="string">&#x27;&#x27;</span>, conf_thres=<span class="number">0.001</span>, iou_thres=<span class="number">0.65</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> save_dir <span class="keyword">and</span> os.path.dirname(save_dir) != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        os.makedirs(os.path.dirname(save_dir), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> test.test(</span><br><span class="line">        <span class="string">&quot;data/coco.yaml&quot;</span>,</span><br><span class="line">        save_dir=Path(save_dir),</span><br><span class="line">        conf_thres=conf_thres,</span><br><span class="line">        iou_thres=iou_thres,</span><br><span class="line">        model=model,</span><br><span class="line">        dataloader=loader,</span><br><span class="line">        is_coco=<span class="literal">True</span>,</span><br><span class="line">        plots=<span class="literal">False</span>,</span><br><span class="line">        half_precision=<span class="literal">True</span>,</span><br><span class="line">        save_json=<span class="literal">False</span></span><br><span class="line">    )[<span class="number">0</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    weight = <span class="string">&quot;yolov7.pt&quot;</span></span><br><span class="line"></span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    model = load_yolov7_model(weight, device)</span><br><span class="line"></span><br><span class="line">    cocodir = <span class="string">&quot;dataset/coco2017&quot;</span></span><br><span class="line">    dataloader = prepare_dataset(cocodir)</span><br><span class="line"></span><br><span class="line">    ap = evaluate_coco(model, dataloader)</span><br></pre></td></tr></table></figure>
<p>åœ¨æ­£å¼å¼€å§‹æµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ä¸‹ data/coco.yaml æ–‡ä»¶ï¼Œä¸»è¦ä¿®æ”¹ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>æ³¨é‡Šç¬¬ 4 è¡Œçš„æ•°æ®ä¸‹è½½</li>
<li>ä¿®æ”¹ç¬¬ 7 è¡Œå’Œ ç¬¬ 8 è¡Œçš„ txt è·¯å¾„</li>
<li>æ³¨é‡Šç¬¬ 9 è¡Œçš„ test è·¯å¾„</li>
</ul>
<p>å®Œæ•´çš„ coco.yaml æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># COCO 2017 dataset http://cocodataset.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download command/URL (optional)</span></span><br><span class="line"><span class="comment"># download: bash ./scripts/get_coco.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># train and val data as 1) directory: path/images/, 2) file: path/images.txt, or 3) list: [path1/images/, path2/images/]</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">D:\\YOLO\\yolov7-qat\\yolov7-main\\dataset\\coco2017\\train2017.txt</span>  <span class="comment"># 118287 images</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">D:\\YOLO\\yolov7-qat\\yolov7-main\\dataset\\coco2017\\val2017.txt</span>  <span class="comment"># 5000 images</span></span><br><span class="line"><span class="comment"># test: ./coco/test-dev2017.txt  # 20288 of 40670 images, submit to https://competitions.codalab.org/competitions/20794</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># number of classes</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># class names</span></span><br><span class="line"><span class="attr">names:</span> [ <span class="string">&#x27;person&#x27;</span>, <span class="string">&#x27;bicycle&#x27;</span>, <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;motorcycle&#x27;</span>, <span class="string">&#x27;airplane&#x27;</span>, <span class="string">&#x27;bus&#x27;</span>, <span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;truck&#x27;</span>, <span class="string">&#x27;boat&#x27;</span>, <span class="string">&#x27;traffic light&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;fire hydrant&#x27;</span>, <span class="string">&#x27;stop sign&#x27;</span>, <span class="string">&#x27;parking meter&#x27;</span>, <span class="string">&#x27;bench&#x27;</span>, <span class="string">&#x27;bird&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;horse&#x27;</span>, <span class="string">&#x27;sheep&#x27;</span>, <span class="string">&#x27;cow&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;elephant&#x27;</span>, <span class="string">&#x27;bear&#x27;</span>, <span class="string">&#x27;zebra&#x27;</span>, <span class="string">&#x27;giraffe&#x27;</span>, <span class="string">&#x27;backpack&#x27;</span>, <span class="string">&#x27;umbrella&#x27;</span>, <span class="string">&#x27;handbag&#x27;</span>, <span class="string">&#x27;tie&#x27;</span>, <span class="string">&#x27;suitcase&#x27;</span>, <span class="string">&#x27;frisbee&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;skis&#x27;</span>, <span class="string">&#x27;snowboard&#x27;</span>, <span class="string">&#x27;sports ball&#x27;</span>, <span class="string">&#x27;kite&#x27;</span>, <span class="string">&#x27;baseball bat&#x27;</span>, <span class="string">&#x27;baseball glove&#x27;</span>, <span class="string">&#x27;skateboard&#x27;</span>, <span class="string">&#x27;surfboard&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;tennis racket&#x27;</span>, <span class="string">&#x27;bottle&#x27;</span>, <span class="string">&#x27;wine glass&#x27;</span>, <span class="string">&#x27;cup&#x27;</span>, <span class="string">&#x27;fork&#x27;</span>, <span class="string">&#x27;knife&#x27;</span>, <span class="string">&#x27;spoon&#x27;</span>, <span class="string">&#x27;bowl&#x27;</span>, <span class="string">&#x27;banana&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;sandwich&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>, <span class="string">&#x27;broccoli&#x27;</span>, <span class="string">&#x27;carrot&#x27;</span>, <span class="string">&#x27;hot dog&#x27;</span>, <span class="string">&#x27;pizza&#x27;</span>, <span class="string">&#x27;donut&#x27;</span>, <span class="string">&#x27;cake&#x27;</span>, <span class="string">&#x27;chair&#x27;</span>, <span class="string">&#x27;couch&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;potted plant&#x27;</span>, <span class="string">&#x27;bed&#x27;</span>, <span class="string">&#x27;dining table&#x27;</span>, <span class="string">&#x27;toilet&#x27;</span>, <span class="string">&#x27;tv&#x27;</span>, <span class="string">&#x27;laptop&#x27;</span>, <span class="string">&#x27;mouse&#x27;</span>, <span class="string">&#x27;remote&#x27;</span>, <span class="string">&#x27;keyboard&#x27;</span>, <span class="string">&#x27;cell phone&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;microwave&#x27;</span>, <span class="string">&#x27;oven&#x27;</span>, <span class="string">&#x27;toaster&#x27;</span>, <span class="string">&#x27;sink&#x27;</span>, <span class="string">&#x27;refrigerator&#x27;</span>, <span class="string">&#x27;book&#x27;</span>, <span class="string">&#x27;clock&#x27;</span>, <span class="string">&#x27;vase&#x27;</span>, <span class="string">&#x27;scissors&#x27;</span>, <span class="string">&#x27;teddy bear&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;hair drier&#x27;</span>, <span class="string">&#x27;toothbrush&#x27;</span> ]</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹å®Œæˆä¹‹åæˆ‘ä»¬å°±å¯ä»¥åœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤å®Œæˆ mAP çš„æµ‹è¯•äº†ï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ptq.py</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/075ea1a990307b383f44c3dd7ea2304e.png" class="" title="075ea1a990307b383f44c3dd7ea2304e">
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ€ç»ˆæµ‹è¯•çš„ mAP@.5:.95 å€¼æ˜¯ 0.454ï¼Œé‚£ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬æµ‹è¯• mAP çš„ä¸€ä¸ªç®€å•æµç¨‹äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å¦‚ä½•åœ¨æ¨¡å‹ä¸­æ’å…¥ QDQ èŠ‚ç‚¹ã€‚</p>
<h1 id="3-æ’å…¥QDQèŠ‚ç‚¹"><a href="#3-æ’å…¥QDQèŠ‚ç‚¹" class="headerlink" title="3. æ’å…¥QDQèŠ‚ç‚¹"></a>3. æ’å…¥QDQèŠ‚ç‚¹</h1><h2 id="3-1-è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹"><a href="#3-1-è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹" class="headerlink" title="3.1 è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹"></a>3.1 è‡ªåŠ¨æ’å…¥QDQèŠ‚ç‚¹</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹è‡ªåŠ¨æ’å…¥ QDQ èŠ‚ç‚¹ï¼Œç¼–å†™ <strong>prepare_model</strong> å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_model</span>(<span class="params">weight, device</span>):</span><br><span class="line">    quant_modules.initialize()</span><br><span class="line">    model = load_yolov7_model(weight, device)</span><br><span class="line">    model.<span class="built_in">float</span>()</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        model.fuse()    <span class="comment"># conv bn è¿›è¡Œå±‚çš„åˆå¹¶, åŠ é€Ÿ</span></span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ initialize å‡½æ•°æ¥è‡ªåŠ¨æ’å…¥ QDQ èŠ‚ç‚¹ï¼Œæˆ‘ä»¬æ‰“å°å¯¹æ¯”ä¸‹åŸæ¥çš„ torch æ¨¡å‹å’Œæ’å…¥ QDQ èŠ‚ç‚¹æ¨¡å‹ç»“æ„çš„å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/e130471d29babd681626fb5413ac083f.png" class="" title="e130471d29babd681626fb5413ac083f">
<p><strong>å›¾3-1 åŸå§‹torchæ¨¡å‹</strong></p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/d06c38807b1aaa233e9d24c9cbd5e86a.png" class="" title="d06c38807b1aaa233e9d24c9cbd5e86a">
<p><strong>å›¾3-2 æ’å…¥QDQèŠ‚ç‚¹æ¨¡å‹</strong></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º torch æ¨¡å‹çš„ç»“æ„æ˜¯æˆ‘ä»¬å¸¸è§çš„ä¸€ä¸ªå·ç§¯å±‚çš„ç»“æ„ï¼Œè€Œæ’å…¥äº†é‡åŒ–èŠ‚ç‚¹çš„æ¨¡å‹ç»“æ„å¯ä»¥çœ‹åˆ°å¤šäº†ä¸¤ä¸ªè¾“å…¥ _input_quantizer å’Œ _weight_quantizerï¼Œå¦å¤– Conv2d ä¹Ÿå˜æˆäº†å¯¹åº”çš„é‡åŒ–ç‰ˆ QuantConv2dã€‚</p>
<p>è‡³æ­¤ï¼ŒQDQ èŠ‚ç‚¹çš„è‡ªåŠ¨æ’å…¥å°±å®Œæˆäº†ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸‹ initializer å…·ä½“çš„å·¥ä½œæµç¨‹ï¼Œå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">float_module_list=<span class="literal">None</span>, custom_quant_modules=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Dynamic module replacement using monkey patching.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Dynamically monkey patches the modules with their quantized versions. Internally, the</span></span><br><span class="line"><span class="string">    state is maintained by a helper class object which helps in replacing the original</span></span><br><span class="line"><span class="string">    modules back.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        float_module_list: A list. User supplied list which indicates which modules to not monkey patch.</span></span><br><span class="line"><span class="string">        custom_quant_modules: A dict. A mapping provided by user to indicate any other module apart</span></span><br><span class="line"><span class="string">            from torch.nn and its corresponding quantized version.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        nothing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Typical usage example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        # Define the deny list for torch.nn modules and custom map for modules other than torch.nn.</span></span><br><span class="line"><span class="string">        float_module_list = [&quot;Linear&quot;]</span></span><br><span class="line"><span class="string">        custom_quant_modules = [(torch.nn, &quot;Linear&quot;, quant_nn.QuantLinear)]</span></span><br><span class="line"><span class="string">        ## Monkey patch the modules</span></span><br><span class="line"><span class="string">        pytorch_quantization.quant_modules.initialize(float_module_list, custom_modules)</span></span><br><span class="line"><span class="string">        ## Use the quantized modules</span></span><br><span class="line"><span class="string">        pytorch_quantization.quant_modules.deactivate()</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    _quant_module_helper_object.prepare_state(float_module_list, custom_quant_modules)</span><br><span class="line">    _quant_module_helper_object.apply_quant_modules()</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆ <strong>initialize</strong> å‡½æ•°å±äº <strong>pytorch_quantization.quant_modules</strong> æ¨¡å—ï¼Œå®ƒç”¨äºåˆå§‹åŒ–é‡åŒ–è¿‡ç¨‹ï¼Œé€šè¿‡æ‰€è°“çš„ <strong>monkey patching</strong> åŠ¨æ€åœ°æ›¿æ¢æ¨¡å‹ä¸­çš„æ¨¡å—ä¸ºå®ƒä»¬çš„é‡åŒ–ç‰ˆæœ¬ã€‚</p>
<p>å®ƒåŒ…å«ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><strong>float_module_list</strong>ï¼šç”¨æˆ·æä¾›çš„åˆ—è¡¨ï¼Œç”¨æ¥æŒ‡ç¤ºå“ªäº›æ¨¡å—ä¸åº”è¯¥è¢«æ›¿æ¢ä¸ºé‡åŒ–ç‰ˆæœ¬ã€‚è¿™å…è®¸ç”¨æˆ·å¯¹å“ªäº›æ¨¡å—è¿›è¡Œé‡åŒ–æœ‰æ›´ç»†ç²’åº¦çš„æ§åˆ¶</li>
<li><strong>custom_quant_modules</strong>ï¼šç”¨æˆ·æä¾›çš„å­—å…¸ï¼Œå¯ä»¥ç”¨äºæŒ‡ç¤ºé™¤äº† <strong>torch.nn</strong> ä¹‹å¤–çš„å…¶ä»–æ¨¡å—åŠå…¶å¯¹åº”çš„é‡åŒ–ç‰ˆæœ¬ã€‚è¿™å…è®¸ç”¨æˆ·ä¸ºè‡ªå®šä¹‰çš„æ¨¡å—æŒ‡å®šé‡åŒ–ç‰ˆæœ¬</li>
</ul>
<p>å®ƒçš„å·¥ä½œæµç¨‹åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<p><strong>1.</strong> <strong>å‡†å¤‡çŠ¶æ€</strong></p>
<ul>
<li>ä½¿ç”¨ <strong>prepare_state</strong> å‡½æ•°æ¥å‡†å¤‡é‡åŒ–çš„çŠ¶æ€</li>
<li>è¿™ä¸ªå‡½æ•°æ¥æ”¶ <strong>float_module_list</strong> å’Œ <strong>custom_quant_modules</strong> å‚æ•°ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™ä¸€ä¸ªè¾…åŠ©ç±»å¯¹è±¡</li>
<li>è¾…åŠ©ç±»å¯¹è±¡ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥ç¡®å®šå“ªäº›æ¨¡å—åº”è¯¥è¢«æ›¿æ¢ä¸ºé‡åŒ–ç‰ˆæœ¬ï¼Œå“ªäº›åº”è¯¥ä¿æŒåŸæ ·</li>
</ul>
<p><strong>2.</strong> <strong>åº”ç”¨é‡åŒ–æ¨¡å—</strong></p>
<ul>
<li>æ¥ä¸‹æ¥ï¼Œ<strong>apply_quant_modules</strong> å‡½æ•°æ¥å®é™…åº”ç”¨é‡åŒ–</li>
<li>åœ¨è¿™ä¸€æ­¥ä¸­ï¼ŒåŸå§‹çš„æ¨¡å—è¢«å®ƒä»¬çš„é‡åŒ–ç‰ˆæœ¬æ‰€æ›¿æ¢ã€‚å¯¹äº <strong>torch.nn</strong> ä¸­çš„æ ‡å‡†æ¨¡å—ï¼Œæ¯”å¦‚è¯´ <strong>torch.nn.Conv2d</strong> ä¼šè¢«æ›¿æ¢ä¸º <strong>quant_nn.QuantConv2d</strong></li>
<li>å¯¹äºç”¨æˆ·æŒ‡å®šçš„è‡ªå®šä¹‰æ¨¡å—ï¼Œå°†ä½¿ç”¨ <strong>custom_quant_modules</strong> ä¸­æä¾›çš„æ˜ å°„æ¥è¿›è¡Œæ›¿æ¢</li>
</ul>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹å…·ä½“çš„å®ç°æ¨¡å—æ›¿æ¢çš„ QuantModuleReplacementHelper ç±»ï¼Œå®ƒçš„ç»“æ„å’ŒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<p><strong>ç±»å±æ€§</strong></p>
<ul>
<li><strong>orginal_func_map</strong>ï¼šç”¨äºå­˜å‚¨åŸå§‹æ¨¡å—ï¼Œè¿™äº›åŸå§‹æ¨¡å—åœ¨è¿›è¡Œ <strong>monkey patching</strong> æ—¶ä¼šè¢«æ›¿æ¢</li>
<li><strong>default_quant_map</strong>ï¼šå­˜å‚¨ pytorch_quantization å·¥å…·æ‰€æ”¯æŒçš„é»˜è®¤é‡åŒ–æ¨¡å—çš„åˆ—è¡¨ï¼Œè¿™äº›æ˜¯å†…ç½®çš„é‡åŒ–ç‰ˆæœ¬ï¼Œé€šå¸¸å¯¹åº”äº torch.nn ä¸­çš„æ ‡å‡†æ¨¡å—ï¼Œæ¯”å¦‚ Convã€Poolã€LSTM ç­‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—çš„é‡åŒ–ç‰ˆæ›¿æ¢çš„æ—¶å€™éœ€è¦ä½¿ç”¨ <strong>namedtuple</strong> è¿™ç§å½¢å¼ã€‚</li>
<li><strong>quant_map</strong>ï¼šå­˜å‚¨æœ€ç»ˆçš„é‡åŒ–æ¨¡å—ï¼Œç€åŒ…æ‹¬ pytorch_quantization é»˜è®¤çš„é‡åŒ–æ¨¡å—å’Œç”¨æˆ·æä¾›çš„è‡ªå®šä¹‰é‡åŒ–æ¨¡å—</li>
</ul>
<p><strong>prepare_state æ–¹æ³•</strong></p>
<ul>
<li>è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨äºå‡†å¤‡ <strong>monkey patching</strong> æœºåˆ¶ä¸­ä½¿ç”¨çš„é‡åŒ–æ¨¡å—åˆ—è¡¨</li>
<li>å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼š<strong>float_module_list</strong> å’Œ <strong>custom_map</strong></li>
<li><strong>float_module_list</strong> æ˜¯ç”¨æˆ·æŒ‡å®šçš„ä¸åº”è¯¥è¢«æ›¿æ¢çš„æ¨¡å—åˆ—è¡¨</li>
<li><strong>custom_map</strong> æ˜¯ç”¨æˆ·æä¾›çš„é™¤äº† <strong>torch.nn</strong> ä¹‹å¤–çš„è‡ªå®šä¹‰æ¨¡å—é‡åŒ–ç‰ˆæœ¬çš„æ˜ å°„</li>
<li>è¯¥æ–¹æ³•é¦–å…ˆåŸºäº <strong>default_quant_map</strong> ç”Ÿæˆ <strong>quant_map</strong>ï¼Œä½†ä¼šè·³è¿‡ <strong>float_module_list</strong> ä¸­æŒ‡å®šçš„æ¨¡å—</li>
<li>ç„¶åï¼Œå®ƒä¼šå°† <strong>custom_map</strong> ä¸­çš„è‡ªå®šä¹‰æ¨¡å—æ·»åŠ åˆ° <strong>quant_map</strong> ä¸­</li>
<li>åŒæ—¶ï¼Œå®ƒä¹Ÿä¼šåœ¨ <strong>orginal_func_map</strong> ä¸­å­˜å‚¨åŸå§‹æ¨¡å—ï¼Œä»¥ä¾¿ä»¥åå¯ä»¥æ¢å¤ã€‚</li>
</ul>
<p><strong>apply_quant_modules æ–¹æ³•</strong></p>
<ul>
<li>è¿™ä¸ªç”¨äºå®é™…åº”ç”¨ <strong>monkey patching</strong></li>
<li>å®ƒä¼šéå† <strong>quant_map</strong> ä¸­æ³¨å†Œçš„æ¨¡å—ï¼Œå°†å®ƒä»¬æ›¿æ¢ä¸ºé‡åŒ–ç‰ˆæœ¬ï¼Œå¹¶åœ¨ <strong>orginal_func_map</strong> ä¸­å­˜å‚¨åŸå§‹æ¨¡å—ï¼Œä»¥ä¾¿ä»¥åæ¢å¤</li>
<li>æˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ›¿æ¢ torch.nn ä¸­çš„æ¨¡å—ï¼Œå°†å…¶å˜ä¸ºé‡åŒ–ç‰ˆæœ¬ï¼Œä»è€Œå®ç°æ¨¡å‹çš„é‡åŒ–ã€‚</li>
</ul>
<p><strong>restore_float_modules æ–¹æ³•</strong></p>
<ul>
<li>è¿™ä¸ªæ–¹æ³•ç”¨äºæ¢å¤åŸå§‹æ¨¡å—ï¼Œå³æ’¤é”€ä¹‹å‰åº”ç”¨çš„ <strong>monkey patching</strong></li>
<li>å®ƒä¼šéå† <strong>orginal_func_map</strong>ï¼Œå°†åŸå§‹æ¨¡å—æ›¿æ¢å›å»</li>
</ul>
<p>ç»¼ä¸Šï¼Œ<strong>QuantModuleReplacementHelper</strong> ç±»æ˜¯ä¸€ä¸ªé‡è¦çš„è¾…åŠ©ç±»ï¼Œç”¨äºå®ç°æ¨¡å—çš„åŠ¨æ€æ›¿æ¢ï¼Œä»¥ä¾¿è¿›è¡Œ<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96&amp;spm=1001.2101.3001.7020">æ¨¡å‹é‡åŒ–</a>ã€‚é€šè¿‡è¿™ä¸ªç±»ï¼Œç”¨æˆ·å¯ä»¥çµæ´»åœ°æŒ‡å®šå“ªäº›æ¨¡å—åº”è¯¥è¢«é‡åŒ–ï¼Œå“ªäº›ä¸åº”è¯¥è¢«é‡åŒ–ï¼Œç”šè‡³å¯ä»¥æä¾›è‡ªå®šä¹‰çš„é‡åŒ–æ¨¡å—ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”çµæ´»çš„æ–¹å¼æ¥æ›¿æ¢æ¨¡å‹çš„é‡åŒ–ç‰ˆæœ¬ã€‚</p>
<p>é‚£ä¸‹é¢æˆ‘ä»¬å°±æ¥å…·ä½“çœ‹çœ‹é‡åŒ–ç‰ˆæœ¬çš„æ¨¡å—åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¬ä»¥ <strong>QuantConv2d</strong> ä¸ºä¾‹è¯´æ˜</p>
<p>é¦–å…ˆ <strong>QuantConv2d</strong> ç»§æ‰¿è‡ª <strong>_QuantConvNd</strong>ï¼Œè€Œ <strong>_QuantConvNd</strong> åˆç»§æ‰¿è‡ª <strong>torch.nn.modules.conv._ConvNd</strong> å’Œ <strong>_utils.QuantMixin</strong>ï¼Œé‚£æˆ‘ä»¬é‡ç‚¹æ¥å…³æ³¨ä¸‹ <strong>QuantMixin</strong> ç±»çš„å·¥ä½œæµç¨‹</p>
<p><strong>QuantMixin</strong> ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QuantMixin</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Mixin class for adding basic quantization logic to quantized modules&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    default_quant_desc_input = QUANT_DESC_8BIT_PER_TENSOR</span><br><span class="line">    default_quant_desc_weight = QUANT_DESC_8BIT_PER_TENSOR</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_default_quant_desc_input</span>(<span class="params">cls, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            value: An instance of :class:`QuantDescriptor &lt;pytorch_quantization.tensor_quant.QuantDescriptor&gt;`</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, QuantDescriptor):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;&#123;&#125; is not an instance of QuantDescriptor!&quot;</span>)</span><br><span class="line">        cls.default_quant_desc_input = copy.deepcopy(value)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_default_quant_desc_weight</span>(<span class="params">cls, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            value: An instance of :class:`QuantDescriptor &lt;pytorch_quantization.tensor_quant.QuantDescriptor&gt;`</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, QuantDescriptor):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;&#123;&#125; is not an instance of QuantDescriptor!&quot;</span>)</span><br><span class="line">        cls.default_quant_desc_weight = copy.deepcopy(value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_quantizer</span>(<span class="params">self, quant_desc_input, quant_desc_weight, num_layers=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Helper function for __init__ of quantized module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Create input and weight quantizer based on quant_desc passed by kwargs, or default of the class.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            quant_desc_input: An instance of :class:`QuantDescriptor &lt;pytorch_quantization.tensor_quant.QuantDescriptor&gt;`</span></span><br><span class="line"><span class="string">            quant_desc_weight: An instance of :class:`QuantDescriptor &lt;pytorch_quantization.tensor_quant.QuantDescriptor&gt;`</span></span><br><span class="line"><span class="string">            num_layers: An integer. Default None. If not None, create a list of quantizers.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> inspect.stack()[<span class="number">1</span>].function == <span class="string">&quot;__init__&quot;</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#123;&#125; should be only called by __init__ of quantized module.&quot;</span>.<span class="built_in">format</span>(__name__))</span><br><span class="line">        self._fake_quant = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> quant_desc_input.fake_quant) <span class="keyword">or</span> (<span class="keyword">not</span> quant_desc_weight.fake_quant):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Only fake quantization is supported!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">&quot;Input is %squantized to %d bits in %s with axis %s!&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">                     <span class="keyword">if</span> <span class="keyword">not</span> quant_desc_input.fake_quant <span class="keyword">else</span> <span class="string">&quot;fake &quot;</span>,</span><br><span class="line">                     quant_desc_input.num_bits, self.__class__.__name__, quant_desc_input.axis)</span><br><span class="line">        logging.info(<span class="string">&quot;Weight is %squantized to %d bits in %s with axis %s!&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">                     <span class="keyword">if</span> <span class="keyword">not</span> quant_desc_weight.fake_quant <span class="keyword">else</span> <span class="string">&quot;fake &quot;</span>,</span><br><span class="line">                     quant_desc_weight.num_bits, self.__class__.__name__, quant_desc_weight.axis)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_layers <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self._input_quantizer = TensorQuantizer(quant_desc_input)</span><br><span class="line">            self._weight_quantizer = TensorQuantizer(quant_desc_weight)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._input_quantizers = nn.ModuleList([TensorQuantizer(quant_desc_input) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_layers)])</span><br><span class="line">            self._weight_quantizers = nn.ModuleList([TensorQuantizer(quant_desc_weight) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_layers)])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pylint:disable=missing-docstring</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">input_quantizer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._input_quantizer</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">weight_quantizer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._weight_quantizer</span><br><span class="line">    <span class="comment"># pylint:enable=missing-docstring</span></span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªæ··åˆç±»ï¼Œç”¨äºå‘é‡åŒ–æ¨¡å—å’ŒåŸºæœ¬çš„é‡åŒ–é€»è¾‘ï¼Œå®ƒçš„ç»“æ„å’ŒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<p><strong>ç±»å±æ€§</strong></p>
<ul>
<li><strong>default_quant_desc_input</strong>: è¾“å…¥å¼ é‡çš„é»˜è®¤é‡åŒ–æè¿°ç¬¦ã€‚</li>
<li><strong>default_quant_desc_weight</strong>: æƒé‡å¼ é‡çš„é»˜è®¤é‡åŒ–æè¿°ç¬¦ã€‚</li>
</ul>
<p><strong>set_default_quant_desc_input(weight) ç±»æ–¹æ³•</strong></p>
<ul>
<li>è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äºè®¾ç½®è¾“å…¥å’Œæƒé‡å¼ é‡çš„è‡ªå®šä¹‰æè¿°ç¬¦</li>
<li>å®ƒä»¬æ¥å—ä¸€ä¸ª <strong>QuantDescriptor</strong> å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†å…¶å¤åˆ¶ä¸ºå¯¹åº”çš„é»˜è®¤æè¿°ç¬¦</li>
</ul>
<p><strong>init_quantizer æ–¹æ³•</strong></p>
<ul>
<li>è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œé€šå¸¸åœ¨é‡åŒ–æ¨¡å—çš„ <strong>__init__</strong> æ–¹æ³•ä¸­è°ƒç”¨</li>
<li>å®ƒä¼šæ ¹æ®æä¾›çš„é‡åŒ–æè¿°ç¬¦åˆ›å»ºè¾“å…¥å’Œæƒé‡é‡åŒ–å™¨ï¼Œé€šè¿‡ <strong>TensorQuantizer</strong> æ¥åˆ›å»º</li>
</ul>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯æè¿°ç¬¦æ˜¯ <strong>ScaleQuantDescriptor</strong> ç±»çš„å®ä¾‹ï¼Œ<strong>ScaleQuantDescriptor</strong> ç±»çš„æè¿°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ScaledQuantDescriptor</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Supportive descriptor of quantization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Describe how a tensor should be quantized. A QuantDescriptor and a tensor defines a quantized tensor.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        num_bits: An integer. Number of bits of quantization. It is used to calculate scaling factor. Default 8.</span></span><br><span class="line"><span class="string">        name: Seems a nice thing to have</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Keyword Arguments:</span></span><br><span class="line"><span class="string">        fake_quant: A boolean. If True, use fake quantization mode. Default True.</span></span><br><span class="line"><span class="string">        axis: None, int or tuple of int. axes which will have its own max for computing scaling factor.</span></span><br><span class="line"><span class="string">            If None (the default), use per tensor scale.</span></span><br><span class="line"><span class="string">            Must be in the range [-rank(input_tensor), rank(input_tensor)).</span></span><br><span class="line"><span class="string">            e.g. For a KCRS weight tensor, quant_axis=(0) will yield per channel scaling.</span></span><br><span class="line"><span class="string">            Default None.</span></span><br><span class="line"><span class="string">        amax: A float or list/ndarray of floats of user specified absolute max range. If supplied,</span></span><br><span class="line"><span class="string">            ignore quant_axis and use this to quantize. If learn_amax is True, will be used to initialize</span></span><br><span class="line"><span class="string">            learnable amax. Default None.</span></span><br><span class="line"><span class="string">        learn_amax: A boolean. If True, learn amax. Default False.</span></span><br><span class="line"><span class="string">        scale_amax: A float. If supplied, multiply amax by scale_amax. Default None. It is useful for some</span></span><br><span class="line"><span class="string">            quick experiment.</span></span><br><span class="line"><span class="string">        calib_method: A string. One of [&quot;max&quot;, &quot;histogram&quot;] indicates which calibration to use. Except the simple</span></span><br><span class="line"><span class="string">            max calibration, other methods are all hisogram based. Default &quot;max&quot;.</span></span><br><span class="line"><span class="string">        unsigned: A Boolean. If True, use unsigned. Default False.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        TypeError: If unsupported type is passed in.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Read-only properties:</span></span><br><span class="line"><span class="string">        - fake_quant:</span></span><br><span class="line"><span class="string">        - name:</span></span><br><span class="line"><span class="string">        - learn_amax:</span></span><br><span class="line"><span class="string">        - scale_amax:</span></span><br><span class="line"><span class="string">        - axis:</span></span><br><span class="line"><span class="string">        - calib_method:</span></span><br><span class="line"><span class="string">        - num_bits:</span></span><br><span class="line"><span class="string">        - amax:</span></span><br><span class="line"><span class="string">        - unsigned:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_bits=<span class="number">8</span>, name=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>å®ƒæè¿°äº†å¼ é‡åº”è¯¥å¦‚ä½•è¿›è¡Œé‡åŒ–ï¼Œè¿™ä¸ªç±»å®šä¹‰äº†é‡åŒ–æ‰€éœ€çš„å‚æ•°å’Œå±æ€§ï¼Œæä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥é…ç½®é‡åŒ–è¿‡ç¨‹ï¼Œå®ƒçš„ç»“æ„å’ŒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<p><strong>ç±»å±æ€§</strong></p>
<ul>
<li><strong>num_bits</strong>ï¼šé‡åŒ–ä½æ•°ï¼Œç”¨äºè®¡ç®—ç¼©æ”¾å› å­</li>
<li><strong>fake_quant</strong>ï¼šä¼ªé‡åŒ–æ¨¡å¼ï¼Œå¦‚æœè®¾ç½®ä¸º Trueï¼Œåˆ™ä½¿ç”¨ä¼ªé‡åŒ–ï¼Œé»˜è®¤ä¸º True</li>
<li><strong>axis</strong>ï¼šç”¨äºè®¡ç®—ç¼©æ”¾å› å­ scale çš„è½´ï¼Œå¦‚æœä¸º Noneï¼Œåˆ™ä½¿ç”¨æ¯ä¸ªå¼ é‡è®¡ç®— scaleï¼Œä¾‹å¦‚ input_quantï¼›å¦‚æœç­‰äº 0 å°†æŒ‰ç…§æ¯ä¸ªé€šé“è®¡ç®— scaleï¼Œé»˜è®¤ä¸º None</li>
<li><strong>amax</strong>ï¼šåŠ¨æ€èŒƒå›´çš„æœ€å¤§å€¼ï¼Œå¦‚æœç”¨æˆ·æä¾›ï¼Œåˆ™ä½¿ç”¨è¯¥å€¼è¿›è¡Œé‡åŒ–</li>
<li><strong>learn_amax</strong>ï¼šå¸ƒå°”å€¼ï¼Œå¦‚æœä¸º True åˆ™å°†å­¦ä¹  amaxï¼Œé»˜è®¤ False</li>
<li><strong>scale_amax</strong>ï¼šå¦‚æœç”¨æˆ·æä¾›ï¼Œåˆ™ä¼šå°† amax ä¹˜ä»¥ scale_amaxï¼Œé»˜è®¤ None</li>
<li><strong>calib_method</strong>ï¼šæ ¡å‡†æ–¹æ³•ï¼Œå¯ä»¥æ˜¯ Max æœ€å¤§å€¼æ ¡å‡†æˆ–è€… Histogram ç›´æ–¹å›¾æ ¡å‡†ï¼Œé»˜è®¤ç›´æ–¹å›¾æ ¡å‡†</li>
</ul>
<p>è€Œé‡åŒ–å™¨æ¨¡å— <strong>TensorQuantizer</strong> ç±»çš„æè¿°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TensorQuantizer</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Tensor quantizer module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This module uses tensor_quant or fake_tensor_quant function to quantize a tensor. And wrappers variable, moving</span></span><br><span class="line"><span class="string">    statistics we&#x27;d want when training a quantized network.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Experimental features:</span></span><br><span class="line"><span class="string">        ``clip`` stage learns range before enabling quantization.</span></span><br><span class="line"><span class="string">        ``calib`` stage runs calibration</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        quant_desc: An instance of :func:`QuantDescriptor &lt;pytorch_quantization.tensor_quant.QuantDescriptor&gt;`.</span></span><br><span class="line"><span class="string">        disabled: A boolean. If True, by pass the whole module returns input. Default False.</span></span><br><span class="line"><span class="string">        if_quant: A boolean. If True, run main quantization body. Default True.</span></span><br><span class="line"><span class="string">        if_clip: A boolean. If True, clip before quantization and learn amax. Default False.</span></span><br><span class="line"><span class="string">        if_calib: A boolean. If True, run calibration. Not implemented yet. Settings of calibration will probably</span></span><br><span class="line"><span class="string">            go to :func:`QuantDescriptor &lt;pytorch_quantization.tensor_quant.QuantDescriptor&gt;`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Readonly Properties:</span></span><br><span class="line"><span class="string">        - axis:</span></span><br><span class="line"><span class="string">        - fake_quant:</span></span><br><span class="line"><span class="string">        - scale:</span></span><br><span class="line"><span class="string">        - step_size:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Mutable Properties:</span></span><br><span class="line"><span class="string">        - num_bits:</span></span><br><span class="line"><span class="string">        - unsigned:</span></span><br><span class="line"><span class="string">        - amax:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># An experimental static switch for using pytorch&#x27;s native fake quantization</span></span><br><span class="line">    <span class="comment"># Primary usage is to export to ONNX</span></span><br><span class="line">    use_fb_fake_quant = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, quant_desc=QuantDescriptor(<span class="params"></span>), disabled=<span class="literal">False</span>, if_quant=<span class="literal">True</span>, if_clip=<span class="literal">False</span>, if_calib=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize quantizer and set up required variables&quot;&quot;&quot;</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>è¯¥ç±»æ˜¯æˆ‘ä»¬å®é™…çš„å¼ é‡é‡åŒ–æ¨¡å—ï¼Œå³é‡åŒ–å™¨æ¨¡å—ã€‚å®ƒä½¿ç”¨ tensor_quant æˆ–è€… fake_tensor_quant å‡½æ•°å¯¹å¼ é‡è¿›è¡Œé‡åŒ–ï¼Œç‰¹ç‚¹æ˜¯åœ¨å¯åŠ¨é‡åŒ–ä¹‹å‰å®ƒä¼šè®¡ç®—é‡åŒ–çš„ä¸€ä¸ªåŠ¨æ€èŒƒå›´ï¼Œä¹‹åæ ¹æ®æˆ‘ä»¬é€‰ç”¨çš„æ ¡å‡†æ–¹æ³•æ¥è¿›è¡Œæ ¡å‡†ã€‚å®ƒçš„ç»“æ„å’ŒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<p><strong>__init__ æ–¹æ³•</strong></p>
<ul>
<li>æ¥æ”¶ä¸€ä¸ª <strong>QuantDescriptor</strong> é‡åŒ–æè¿°ç¬¦å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œç”¨äºè®¾ç½®é‡åŒ–çš„å„ç§å±æ€§å’Œå‚æ•°</li>
<li><strong>disabled</strong> å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦ç¦ç”¨è¯¥å±‚è¿›è¡Œé‡åŒ–ï¼Œé»˜è®¤ False</li>
<li><strong>if_quant</strong> å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦è¿è¡Œä¸»ä½“é‡åŒ–é€»è¾‘ï¼Œé»˜è®¤ True</li>
<li><strong>if_clip</strong> å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦åœ¨é‡åŒ–å‰è£å‰ªå¹¶å­¦ä¹  amaxï¼Œé»˜è®¤ False</li>
<li><strong>if_calib</strong> å‚æ•°æ§åˆ¶æ˜¯å¦è¿è¡Œæ ¡å‡†ï¼Œé»˜è®¤ False</li>
</ul>
<p>OKï¼ä»¥ä¸Šå°±æ˜¯ QDQ èŠ‚ç‚¹çš„è‡ªåŠ¨æ’å…¥å’Œ initializer å‡½æ•°çš„ç®€å•åˆ†æï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸‹æ‰‹åŠ¨æ’å…¥ QDQ é‡åŒ–èŠ‚ç‚¹ã€‚</p>
<h2 id="3-2-æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹"><a href="#3-2-æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹" class="headerlink" title="3.2 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹"></a>3.2 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹</h2><p>ä¸Šé¢æˆ‘ä»¬å¯¹ initializer å‡½æ•°è¿›è¡Œäº†ç®€å•çš„åˆ†æï¼Œå…¶ä¸­æ¶‰åŠäº†å¤šä¸ªç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»ï¼Œä¸‹é¢æ˜¯ initializer å‡½æ•°ä¸­æ¶‰åŠåˆ°çš„ç±»çš„ç»§æ‰¿å…³ç³»å›¾ï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/d266ac5e9fe31c1b7912b94edc202afb.png" class="" title="d266ac5e9fe31c1b7912b94edc202afb">
<p>å¤§å®¶å¯ä»¥æ ¹æ®ä¸Šé¢çš„ç»§æ‰¿å…³ç³»å›¾å¯¹åº”åˆ°å®é™…çš„ä»£ç ä¸­å»çœ‹çœ‹ç›¸åº”çš„ç»§æ‰¿å…³ç³»ï¼Œæ¯”å¦‚åœ¨é‡åŒ–æ¨¡å—è½¬æ¢ä¸­ <strong>QuantConv2d</strong> ç»§æ‰¿è‡ª <strong>_QuantConvNd</strong>ï¼Œè€Œ <strong>QuantConv2d</strong> ä¸ <strong>Conv2d</strong> åˆå¯ä»¥ç›¸äº’è½¬æ¢ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ ¹æ®ä¸Šé¢çš„ç»§æ‰¿å…³ç³»æµç¨‹å›¾æ¥æ‰‹åŠ¨å®ç° QDQ èŠ‚ç‚¹çš„æ’å…¥ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯å®ç°ä¸‰ä¸ªå‡½æ•°ï¼š</p>
<p><strong>1.</strong> <strong>replace_to_quantization_model</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">replace_to_quantization_model</span>(<span class="params">model</span>):</span><br><span class="line">    </span><br><span class="line">    module_list = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> entry <span class="keyword">in</span> quant_modules._DEFAULT_QUANT_MAP:</span><br><span class="line">        module = <span class="built_in">getattr</span>(entry.orig_mod, entry.mod_name)  <span class="comment"># module -&gt; torch.nn.modules.conv.Conv1d</span></span><br><span class="line">        module_list[<span class="built_in">id</span>(module)] = entry.replace_mod</span><br><span class="line">    </span><br><span class="line">    torch_module_find_quant_module(model, module_list)</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°æ˜¯æ‰‹åŠ¨æ’å…¥é‡åŒ–èŠ‚ç‚¹çš„èµ·å§‹å‡½æ•°ï¼Œç›®çš„æ˜¯ä¸ºæ¨¡å‹ç”Ÿæˆä¸€ä¸ªæ›¿æ¢æ˜ å°„ï¼Œå¹¶è°ƒç”¨<a target="_blank" rel="noopener" href="https://edu.csdn.net/course/detail/40020?utm_source=glcblog&amp;spm=1001.2101.3001.7020">é€’å½’</a>å‡½æ•°æ¥æŸ¥æ‰¾å’Œæ›¿æ¢æ¨¡å‹ä¸­çš„æ¨¡å—ã€‚</p>
<ul>
<li><strong>ç”Ÿæˆæ›¿æ¢æ˜ å°„</strong>ï¼šmodule_list å­—å…¸åŸºäº quant_modules._DEFAULT_QUANT_MAP æ„å»ºï¼Œå®ƒåŒ…å«äº†åŸå§‹ pytorch æ¨¡å—ç±»ï¼ˆå¦‚ nn.Conv2dï¼‰åˆ°å®ƒä»¬å¯¹åº”çš„é‡åŒ–æ¨¡å—ç±»ï¼ˆå¦‚ quant_modules.QuantConv2dï¼‰çš„æ˜ å°„ã€‚</li>
<li><strong>è°ƒç”¨é€’å½’å‡½æ•°</strong>ï¼šè°ƒç”¨ torch_module_find_quant_module å‡½æ•°å¼€å§‹é€’å½’è¿‡ç¨‹ï¼Œä¼ å…¥æ¨¡å‹å’Œ module_list ä½œä¸ºå‚æ•°</li>
</ul>
<p><strong>2.</strong> <strong>torch_module_find_quant_module</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">torch_module_find_quant_module</span>(<span class="params">model, module_list, prefix=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> model._modules:</span><br><span class="line">        submodule = model._modules[name]</span><br><span class="line">        path = name <span class="keyword">if</span> prefix == <span class="string">&#x27;&#x27;</span> <span class="keyword">else</span> prefix + <span class="string">&#x27;.&#x27;</span> + name</span><br><span class="line">        torch_module_find_quant_module(submodule, module_list, prefix=path) <span class="comment"># é€’å½’</span></span><br><span class="line"></span><br><span class="line">        submodule_id = <span class="built_in">id</span>(<span class="built_in">type</span>(submodule))</span><br><span class="line">        <span class="keyword">if</span> submodule_id <span class="keyword">in</span> module_list:</span><br><span class="line">            <span class="comment"># è½¬æ¢</span></span><br><span class="line">            model._modules[name] = transfer_torch_to_quantization(submodule, module_list[submodule_id])</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°é€’å½’çš„éå†æ¨¡å‹ä¸­çš„æ‰€æœ‰å­æ¨¡å—ï¼Œå¯»æ‰¾å¯ä»¥è¢«é‡åŒ–ç‰ˆæœ¬æ›¿æ¢çš„æ¨¡å—ã€‚</p>
<ul>
<li><strong>é€’å½’éå†</strong>ï¼šå¯¹äºæ¨¡å‹ä¸­çš„æ¯ä¸€ä¸ªå­æ¨¡å—ï¼Œå‡½æ•°é€’å½’è°ƒç”¨è‡ªèº«ä»¥éå†æ›´æ·±å±‚æ¬¡çš„å­æ¨¡å—</li>
<li><strong>æ£€æŸ¥å¹¶æ›¿æ¢æ¨¡å—</strong>ï¼šå¦‚æœå­æ¨¡å—çš„ç±»å‹å­˜åœ¨äº module_list æ˜ å°„ä¸­ï¼Œåˆ™ä½¿ç”¨ transfer_torch_to_quantization å‡½æ•°å°†å­æ¨¡å—æ›¿æ¢ä¸ºå…¶é‡åŒ–ç‰ˆæœ¬</li>
<li><strong>è·¯å¾„è®°å½•</strong>ï¼šprefix å‚æ•°ç”¨äºè·Ÿè¸ªå½“å‰å­æ¨¡å—åœ¨æ¨¡å‹ä¸­çš„è·¯å¾„</li>
</ul>
<p><strong>3.</strong> <strong>transfer_torch_to_quantization</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_torch_to_quantization</span>(<span class="params">nn_instance, quant_module</span>):</span><br><span class="line">    </span><br><span class="line">    quant_instances = quant_module.__new__(quant_module)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å±æ€§èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">for</span> k, val <span class="keyword">in</span> <span class="built_in">vars</span>(nn_instance).items():</span><br><span class="line">        <span class="built_in">setattr</span>(quant_instances, k, val)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># è¿”å›ä¸¤ä¸ª QuantDescriptor çš„å®ä¾‹ self.__class__ æ˜¯ quant_instance çš„ç±», QuantConv2d</span></span><br><span class="line">        quant_desc_input, quant_desc_weight = quant_nn_utils.pop_quant_desc_in_kwargs(self.__class__)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(self, quant_nn_utils.QuantInputMixin):</span><br><span class="line">            self.init_quantizer(quant_desc_input)</span><br><span class="line">            <span class="comment"># åŠ å¿«é‡åŒ–é€Ÿåº¦</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(self._input_quantizer._calibrator, calib.HistogramCalibrator):</span><br><span class="line">                self._input_quantizer._calibrator._torch_hist = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.init_quantizer(quant_desc_input, quant_desc_weight)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(self._input_quantizer._calibrator, calib.HistogramCalibrator):</span><br><span class="line">                self._input_quantizer._calibrator._torch_hist = <span class="literal">True</span></span><br><span class="line">                self._weight_quantizer._calibrator._torch_hist = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    __init__(quant_instances)</span><br><span class="line">    <span class="keyword">return</span> quant_instances</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒå‡½æ•°ï¼Œç”¨äºå°†ä¸€ä¸ªæ ‡å‡†çš„ pytorch æ¨¡å—å®ä¾‹è½¬æ¢ä¸ºå…¶é‡åŒ–ç‰ˆæœ¬</p>
<ul>
<li><strong>å®ä¾‹é‡åŒ–æ¨¡å—</strong>ï¼šä½¿ç”¨ quant_module å‚æ•°ï¼ˆä¸€ä¸ªé‡åŒ–æ¨¡å—ç±»ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„é‡åŒ–æ¨¡å—å®ä¾‹</li>
<li><strong>å±æ€§å¤åˆ¶</strong>ï¼šå°†åŸå§‹æ¨¡å— nn_instance çš„æ‰€æœ‰å±æ€§å¤åˆ¶åˆ°æ–°çš„é‡åŒ–æ¨¡å—å®ä¾‹ä¸­</li>
<li><strong>åˆå§‹åŒ–é‡åŒ–å™¨</strong>ï¼šé€šè¿‡ é€šè¿‡ __init__ å†…éƒ¨å‡½æ•°è°ƒç”¨ï¼Œä½¿ç”¨ init_quantizer æ–¹æ³•åˆå§‹åŒ–é‡åŒ–å™¨ã€‚è¿™ä¸ªæ­¥éª¤ç¡®ä¿é‡åŒ–æ¨¡å—å…·æœ‰é€‚å½“çš„é‡åŒ–æè¿°ç¬¦ï¼Œå¹¶è®¾ç½®äº†ä»»ä½•å¿…è¦çš„é‡åŒ–å‚æ•°ã€‚</li>
<li><strong>å¯ç”¨ç›´æ–¹å›¾æ ¡å‡†ä¼˜åŒ–</strong>: å¦‚æœé‡åŒ–å™¨ä½¿ç”¨ HistogramCalibratorï¼Œå°†è®¾ç½® _torch_hist æ ‡å¿—ä»¥åŠ é€Ÿç›´æ–¹å›¾è®¡ç®—è¿‡ç¨‹ã€‚</li>
</ul>
<p>å®Œæ•´çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> models.yolo <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">from</span> pytorch_quantization <span class="keyword">import</span> calib</span><br><span class="line"><span class="keyword">from</span> pytorch_quantization <span class="keyword">import</span> quant_modules</span><br><span class="line"><span class="keyword">from</span> pytorch_quantization.nn.modules <span class="keyword">import</span> _utils <span class="keyword">as</span> quant_nn_utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_yolov7_model</span>(<span class="params">weight, device=<span class="string">&#x27;cpu&#x27;</span></span>):</span><br><span class="line">    ckpt  = torch.load(weight, map_location=device)</span><br><span class="line">    model = Model(<span class="string">&quot;cfg/training/yolov7.yaml&quot;</span>, ch=<span class="number">3</span>, nc=<span class="number">80</span>).to(device)</span><br><span class="line">    state_dict = ckpt[<span class="string">&#x27;model&#x27;</span>].<span class="built_in">float</span>().state_dict()</span><br><span class="line">    model.load_state_dict(state_dict, strict=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_model</span>(<span class="params">weight, device</span>):</span><br><span class="line">    model = load_yolov7_model(weight, device)</span><br><span class="line">    model.<span class="built_in">float</span>()</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        model.fuse()    <span class="comment"># conv bn è¿›è¡Œå±‚çš„åˆå¹¶, åŠ é€Ÿ</span></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_torch_to_quantization</span>(<span class="params">nn_instance, quant_module</span>):</span><br><span class="line">    </span><br><span class="line">    quant_instances = quant_module.__new__(quant_module)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å±æ€§èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">for</span> k, val <span class="keyword">in</span> <span class="built_in">vars</span>(nn_instance).items():</span><br><span class="line">        <span class="built_in">setattr</span>(quant_instances, k, val)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># è¿”å›ä¸¤ä¸ª QuantDescriptor çš„å®ä¾‹ self.__class__ æ˜¯ quant_instance çš„ç±», QuantConv2d</span></span><br><span class="line">        quant_desc_input, quant_desc_weight = quant_nn_utils.pop_quant_desc_in_kwargs(self.__class__)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(self, quant_nn_utils.QuantInputMixin):</span><br><span class="line">            self.init_quantizer(quant_desc_input)</span><br><span class="line">            <span class="comment"># åŠ å¿«é‡åŒ–é€Ÿåº¦</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(self._input_quantizer._calibrator, calib.HistogramCalibrator):</span><br><span class="line">                self._input_quantizer._calibrator._torch_hist = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.init_quantizer(quant_desc_input, quant_desc_weight)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(self._input_quantizer._calibrator, calib.HistogramCalibrator):</span><br><span class="line">                self._input_quantizer._calibrator._torch_hist = <span class="literal">True</span></span><br><span class="line">                self._weight_quantizer._calibrator._torch_hist = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    __init__(quant_instances)</span><br><span class="line">    <span class="keyword">return</span> quant_instances</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">torch_module_find_quant_module</span>(<span class="params">model, module_list, prefix=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> model._modules:</span><br><span class="line">        submodule = model._modules[name]</span><br><span class="line">        path = name <span class="keyword">if</span> prefix == <span class="string">&#x27;&#x27;</span> <span class="keyword">else</span> prefix + <span class="string">&#x27;.&#x27;</span> + name</span><br><span class="line">        torch_module_find_quant_module(submodule, module_list, prefix=path) <span class="comment"># é€’å½’</span></span><br><span class="line"></span><br><span class="line">        submodule_id = <span class="built_in">id</span>(<span class="built_in">type</span>(submodule))</span><br><span class="line">        <span class="keyword">if</span> submodule_id <span class="keyword">in</span> module_list:</span><br><span class="line">            <span class="comment"># è½¬æ¢</span></span><br><span class="line">            model._modules[name] = transfer_torch_to_quantization(submodule, module_list[submodule_id])</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replace_to_quantization_model</span>(<span class="params">model</span>):</span><br><span class="line">    </span><br><span class="line">    module_list = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> entry <span class="keyword">in</span> quant_modules._DEFAULT_QUANT_MAP:</span><br><span class="line">        module = <span class="built_in">getattr</span>(entry.orig_mod, entry.mod_name)  <span class="comment"># module -&gt; torch.nn.modules.conv.Conv1d</span></span><br><span class="line">        module_list[<span class="built_in">id</span>(module)] = entry.replace_mod</span><br><span class="line">    </span><br><span class="line">    torch_module_find_quant_module(model, module_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    weight = <span class="string">&quot;yolov7.pt&quot;</span></span><br><span class="line"></span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    pth_model = load_yolov7_model(weight, device)</span><br><span class="line"></span><br><span class="line">    model = prepare_model(weight, device)</span><br><span class="line">    replace_to_quantization_model(model)</span><br><span class="line">    <span class="built_in">print</span>(model)</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/a2e73bee11aec11e9558c33f98da3d88.png" class="" title="a2e73bee11aec11e9558c33f98da3d88">
<p><strong>å›¾3-3 æ‰‹åŠ¨æ’å…¥QDQèŠ‚ç‚¹æ¨¡å‹</strong></p>
<p>å¯ä»¥çœ‹åˆ°å¯¹åº”çš„ pytorch ç®—å­éƒ½å˜æˆäº†å…¶å¯¹åº”çš„é‡åŒ–ç‰ˆæœ¬ï¼ŒåŒæ—¶è¿˜æ‹¥æœ‰äº† _input_quantizer å’Œ _weight_quantizerã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ç®€å•æ€»ç»“ä¸‹æ‰‹åŠ¨æ’å…¥é‡åŒ–èŠ‚ç‚¹çš„æµç¨‹ï¼š</p>
<ul>
<li><p><strong>1. å‡†å¤‡æ¨¡å‹</strong>: åœ¨æ¨¡å‹å‡†å¤‡é˜¶æ®µï¼Œæ‰§è¡Œå¿…è¦çš„ä¼˜åŒ–ï¼ˆå¦‚å±‚èåˆï¼‰ã€‚</p>
</li>
<li><p><strong>2. æ„å»ºæ›¿æ¢æ˜ å°„</strong>: åŸºäºé¢„å®šä¹‰çš„é‡åŒ–æ˜ å°„ï¼ˆquant_modules._DEFAULT_QUANT_MAPï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ˜ å°„å­—å…¸ï¼Œç”¨äºå°†æ ‡å‡†æ¨¡å—æ›¿æ¢ä¸ºç›¸åº”çš„é‡åŒ–æ¨¡å—ã€‚</p>
</li>
<li><p><strong>3. é€’å½’éå†æ¨¡å‹</strong>: ä½¿ç”¨ torch_module_find_quant_module å‡½æ•°é€’å½’åœ°éå†æ•´ä¸ªæ¨¡å‹çš„å­æ¨¡å—ã€‚</p>
</li>
<li><p><strong>4. æ£€æŸ¥å¹¶æ›¿æ¢æ¨¡å—</strong>: å¯¹äºæ¯ä¸ªå­æ¨¡å—ï¼Œå¦‚æœå…¶ç±»å‹åœ¨æ›¿æ¢æ˜ å°„ä¸­ï¼Œåˆ™ä½¿ç”¨ transfer_torch_to_quantization å‡½æ•°å°†å…¶æ›¿æ¢ä¸ºé‡åŒ–ç‰ˆæœ¬ã€‚</p>
</li>
<li><p><strong>5. åˆå§‹åŒ–é‡åŒ–å™¨</strong>: åœ¨é‡åŒ–æ¨¡å—å®ä¾‹ä¸­åˆå§‹åŒ–é‡åŒ–å™¨ï¼Œç¡®ä¿é‡åŒ–æè¿°ç¬¦å’Œæ ¡å‡†å™¨è®¾ç½®æ­£ç¡®ã€‚</p>
</li>
<li><p><strong>6. ä¼˜åŒ–é‡åŒ–è¿‡ç¨‹</strong>: å¦‚æœä½¿ç”¨ç›´æ–¹å›¾æ ¡å‡†å™¨ï¼Œå¼€å¯ _torch_hist ä»¥åŠ å¿«ç›´æ–¹å›¾æ ¡å‡†è¿‡ç¨‹ã€‚</p>
</li>
<li><p><strong>7. æ’å…¥é‡åŒ–èŠ‚ç‚¹</strong>: å°†é‡åŒ–æ¨¡å—å®ä¾‹æ’å…¥åˆ°æ¨¡å‹ä¸­ï¼Œæ›¿æ¢åŸå§‹çš„éé‡åŒ–æ¨¡å—ã€‚</p>
</li>
<li><p><strong>8. å®Œæˆé‡åŒ–å‡†å¤‡</strong>: å®Œæˆè¿™äº›æ­¥éª¤åï¼Œæ¨¡å‹å°±è¢«è½¬æ¢ä¸ºä¸€ä¸ªé‡åŒ–æ¨¡å‹ï¼Œå…¶ä¸­åŒ…å«äº†ä¸ºæ¨æ–­å’Œ/æˆ–è®­ç»ƒè¿‡ç¨‹é‡åŒ–å‡†å¤‡å¥½çš„èŠ‚ç‚¹ã€‚</p>
</li>
</ul>
<p>é€šè¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œæ¨¡å‹ä¸­çš„æ¯ä¸ªç¬¦åˆæ¡ä»¶çš„æ¨¡å—éƒ½ä¼šè¢«å…¶é‡åŒ–ç‰ˆæœ¬æ‰€æ›¿æ¢ã€‚è¿™ç§æ‰‹åŠ¨æ’å…¥é‡åŒ–èŠ‚ç‚¹çš„æ–¹æ³•å¯ä»¥è®©ä½ æœ‰æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œä¾‹å¦‚åœ¨æ¨¡å‹çš„ç‰¹å®šéƒ¨åˆ†ä½¿ç”¨ä¸åŒçš„é‡åŒ–ç­–ç•¥æˆ–æè¿°ç¬¦ã€‚</p>
<p>OKï¼ä»¥ä¸Šå°±æ˜¯ QDQ èŠ‚ç‚¹çš„æ‰‹åŠ¨æ’å…¥ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸‹æ‰‹åŠ¨ initializeã€‚</p>
<h2 id="3-3-æ‰‹åŠ¨initialize"><a href="#3-3-æ‰‹åŠ¨initialize" class="headerlink" title="3.3 æ‰‹åŠ¨initialize"></a>3.3 æ‰‹åŠ¨initialize</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ‰‹åŠ¨æ’å…¥é‡åŒ–èŠ‚ç‚¹åæ¨¡å‹ mAP æµ‹è¯•çš„ç»“æœï¼Œè¿è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/835dc14ca12e4382ef1d6173038e9d7a.png" class="" title="835dc14ca12e4382ef1d6173038e9d7a">
<p>å¯ä»¥çœ‹åˆ°æµ‹è¯•ç»“æœå’Œ torch å·®ä¸å¤šï¼Œæ­¤å¤–é‡åŒ–å™¨ä½¿ç”¨çš„æ˜¯é»˜è®¤ MaxCalibrator æ ¡å‡†å™¨ï¼Œå…¶ä¸­çš„ initialize æ˜¯æŒ‰ç…§<strong>é»˜è®¤çš„æ–¹æ³•</strong>å»è¿›è¡Œåˆå§‹åŒ–çš„ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ‰‹åŠ¨æ¥å®ç° initializeï¼Œä¸ä½¿ç”¨é»˜è®¤çš„ Max é‡åŒ–å™¨è€Œæ˜¯å»ä½¿ç”¨ç›´æ–¹å›¾ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹åº”è¯¥æ€ä¹ˆå»æ“ä½œã€‚</p>
<p><strong>initialize</strong> å‡½æ•°çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> absl <span class="keyword">import</span> logging <span class="keyword">as</span> quant_logging</span><br><span class="line"><span class="keyword">from</span> pytorch_quantization <span class="keyword">import</span> nn <span class="keyword">as</span> quant_nn</span><br><span class="line"><span class="keyword">from</span> pytorch_quantization.tensor_quant <span class="keyword">import</span> QuantDescriptor</span><br><span class="line"></span><br><span class="line"><span class="comment"># input: Max ==&gt; Histogram</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize</span>():</span><br><span class="line">    quant_desc_input = QuantDescriptor(calib_method=<span class="string">&#x27;histogram&#x27;</span>)</span><br><span class="line">    quant_nn.QuantConv2d.set_default_quant_desc_input(quant_desc_input)</span><br><span class="line">    quant_nn.QuantMaxPool2d.set_default_quant_desc_input(quant_desc_input)</span><br><span class="line">    quant_nn.QuantLinear.set_default_quant_desc_input(quant_desc_input)</span><br><span class="line"></span><br><span class="line">    quant_logging.set_verbosity(quant_logging.ERROR)</span><br></pre></td></tr></table></figure>
<p>åœ¨ä»£ç ä¸­æˆ‘ä»¬å°† QuantConv2dã€QuantMaxPool2d ä»¥åŠ QuantLinear çš„ input é‡åŒ–å™¨ä¿®æ”¹ä¸ºäº†ç›´æ–¹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ‰‹åŠ¨ç¼–å†™ initialize ä»è€Œå®Œæˆä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¿›è¡ŒéªŒè¯ï¼Œçœ‹çœ‹é‡åŒ–æ–¹å¼ä¼šä¸ä¼šæœ‰æ‰€å˜åŒ–ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/d38812303c139eff477729e0a7c2c95f.png" class="" title="d38812303c139eff477729e0a7c2c95f">
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° input çš„é‡åŒ–å™¨ä½¿ç”¨çš„æ˜¯ç›´æ–¹å›¾ï¼Œæƒé‡ä¾æ—§ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ Max é‡åŒ–å™¨ï¼Œè¿™è¯´æ˜æˆ‘ä»¬æ‰‹åŠ¨å®ç°çš„ initialize èµ·ä½œç”¨äº†ã€‚å¦å¤–å¯ä»¥çœ‹åˆ° mAP å’Œä¹‹å‰çš„æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰çœŸæ­£çš„å»æ‰§è¡Œç›¸å…³é‡åŒ–æ“ä½œï¼Œè€Œä»…ä»…æ’å…¥äº†é‡åŒ–èŠ‚ç‚¹ã€‚</p>
<p>ä¸‹èŠ‚è¯¾æˆ‘ä»¬å°†ä¼šè®²è§£æ¨¡å‹æ ‡å®šçš„ç›¸å…³å†…å®¹ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><blockquote>
<p>æœ¬æ¬¡è¯¾ç¨‹ä»‹ç»äº† YOLOv7-PTQ é‡åŒ–æµç¨‹ä¸­çš„å‡†å¤‡å·¥ä½œå’Œ QDQ èŠ‚ç‚¹çš„æ’å…¥ï¼Œå…¶ä¸­å‡†å¤‡å·¥ä½œåŒ…æ‹¬æ¨¡å‹å’Œæ•°æ®é›†çš„å‡†å¤‡ï¼Œè€Œé‡åŒ–èŠ‚ç‚¹çš„æ’å…¥æˆ‘ä»¬ä»‹ç»äº†è‡ªåŠ¨å’Œæ‰‹åŠ¨æ’å…¥ä¸¤ç§æ–¹å¼ï¼Œå…¶ä¸­è‡ªåŠ¨æ’å…¥æ˜¯è°ƒç”¨ initialize å‡½æ•°æ¥å®Œæˆçš„ï¼Œè€Œæ‰‹åŠ¨æ’å…¥æ˜¯æ ¹æ® initialize å‡½æ•°ä¸­ç±»çš„ç»§æ‰¿å…³ç³»å›¾æ¥ä¸€æ­¥æ­¥å®ç°çš„ã€‚QDQ èŠ‚ç‚¹æ’å…¥åä»æ¨¡å‹ç»“æ„å¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹å¤šäº† _input_quantizer å’Œ _weight_quantizer ä¸¤ä¸ªè¾“å…¥ï¼ŒåŒæ—¶ torch æ¨¡å—ä¹Ÿå˜æˆäº†å¯¹åº”çš„é‡åŒ–ç‰ˆæœ¬ã€‚æœ€åæˆ‘ä»¬æ‰‹åŠ¨å®ç°äº† initialize å‡½æ•°å°† input çš„æ ¡å‡†å™¨ä»é»˜è®¤çš„ Max æ›¿æ¢æˆäº†ç›´æ–¹å›¾ã€‚</p>
<p>ä¸‹èŠ‚è¯¾ç¨‹æˆ‘ä»¬å°†ä¼šçœŸæ­£çš„å»ç¼–å†™ä»£ç å¯¹æ’å…¥é‡åŒ–èŠ‚ç‚¹çš„æ¨¡å‹è¿›è¡Œæ ‡å®šè®¡ç®—ä»¥å®Œæˆ PTQ æ¨¡å‹çš„é‡åŒ–å’Œå¯¼å‡ºå·¥ä½œã€‚</p>
</blockquote>
<p>æœ¬æ–‡è½¬è‡ª <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40672115/article/details/134108526">https://blog.csdn.net/qq_40672115/article/details/134108526</a>ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>å¥”è·‘çš„IC
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="http://example.com/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%B8%80)/" title="TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€)">http://example.com/TensorRT/TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(ä¸€)/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C</a>
              <a href="/tags/Tensorrt/" rel="tag"><i class="fa fa-tag"></i> Tensorrt</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/TensorRT/TensorRT%E6%95%99%E7%A8%8B-%E5%9F%BA%E4%BA%8E8.6.1/Part5-3-TensorRT%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7/" rel="prev" title="Part5-3-TensorRTæ€§èƒ½ä¼˜åŒ–æ€§èƒ½ä¼˜åŒ–æŠ€å·§">
                  <i class="fa fa-chevron-left"></i> Part5-3-TensorRTæ€§èƒ½ä¼˜åŒ–æ€§èƒ½ä¼˜åŒ–æŠ€å·§
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/TensorRT/TensorRT%E9%87%8F%E5%8C%96%E5%AE%9E%E6%88%98%E8%AF%BEYOLOv7%E9%87%8F%E5%8C%96%EF%BC%9AYOLOv7-PTQ%E9%87%8F%E5%8C%96(%E4%BA%8C)/" rel="next" title="TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(äºŒ)">
                  TensorRTé‡åŒ–å®æˆ˜è¯¾YOLOv7é‡åŒ–ï¼šYOLOv7-PTQé‡åŒ–(äºŒ) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¥”è·‘çš„IC</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"zmurder","repo":"zmurder.github.io","client_id":"cf2343f27b6c29efe0bc","client_secret":"3268a1fa92706c7358d5421f88f76a0f7ada3188","admin_user":"zmurder","distraction_free_mode":true,"proxy":"https://strong-caramel-969805.netlify.app/github_access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"142c897ba22767ffbee62afe8aebdbde"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
