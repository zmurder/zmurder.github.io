<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8693861384618000"
     crossorigin="anonymous"></script>
  <meta name="msvalidate.01" content="7EC20DBC74B004C2782077570E15C280">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8693861384618000"
     crossorigin="anonymous"></script>
    <meta name="description" content="7 cmake综合示例比较简单的例子在“2 cmake简单示例”中介绍过了。这里使用一个综合的例子实现以下功能：">
<meta property="og:type" content="article">
<meta property="og:title" content="7 cmake 综合示例">
<meta property="og:url" content="http://example.com/cmake/7%20cmake%20%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B/index.html">
<meta property="og:site_name" content="奔跑的IC">
<meta property="og:description" content="7 cmake综合示例比较简单的例子在“2 cmake简单示例”中介绍过了。这里使用一个综合的例子实现以下功能：">
<meta property="og:locale">
<meta property="article:published_time" content="2024-12-01T10:13:45.606Z">
<meta property="article:modified_time" content="2024-12-01T10:13:45.606Z">
<meta property="article:author" content="奔跑的IC">
<meta property="article:tag" content="C">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="GPU">
<meta property="article:tag" content="cmake">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/cmake/7%20cmake%20%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://example.com/cmake/7%20cmake%20%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B/","path":"cmake/7 cmake 综合示例/","title":"7 cmake 综合示例"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>7 cmake 综合示例 | 奔跑的IC</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">奔跑的IC</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-reorder fa-fw"></i>文章列表</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#7-cmake%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="nav-text">7 cmake综合示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-text">1 文件结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="nav-text">2 文件内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-hello-cu"><span class="nav-text">2.1 hello.cu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-build-sh"><span class="nav-text">2.2 build.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-CMakeLists-txt"><span class="nav-text">2.3 CMakeLists.txt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-arm-qnx-toolchain-cmake"><span class="nav-text">2.4 arm_qnx_toolchain.cmake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-x86-toolchain-cmake"><span class="nav-text">2.5 x86_toolchain.cmake</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%BC%96%E8%AF%91"><span class="nav-text">3 编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-cuda%E5%92%8Cc-%E6%B7%B7%E5%90%88%E7%BC%96%E8%AF%91"><span class="nav-text">4 cuda和c++混合编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E4%B8%8EGPT%E7%9A%84%E5%AF%B9%E8%AF%9D"><span class="nav-text">5 与GPT的对话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAcuda-%E7%9A%84cmake%E6%96%87%E4%BB%B6"><span class="nav-text">编写一个cuda 的cmake文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BA%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-text">修改为交叉编译的版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E8%AE%BE%E5%AE%9A-CMAKE-CUDA-HOST-COMPILER-%E5%8F%82%E6%95%B0"><span class="nav-text">什么时候需要设定 CMAKE_CUDA_HOST_COMPILER 参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E4%BD%BF%E7%94%A8-find-package"><span class="nav-text">不使用 find_package</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%BA%9B-%E5%85%B6%E4%BB%96%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9%E5%92%8C%E9%85%8D%E7%BD%AE-%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">添加一些 其他交叉编译选项和配置 的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#find-package-%E5%92%8Cenable-language-%E7%94%A8%E5%93%AA%E4%B8%80%E4%B8%AA%EF%BC%9F"><span class="nav-text">find_package 和enable_language 用哪一个？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E6%97%B6-CMAKE-CUDA-HOST-COMPILER%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E8%AE%BE%E5%AE%9A%E4%B8%BAgcc-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E8%AE%BE%E5%AE%9A%E4%B8%BAnvcc"><span class="nav-text">交叉编译时 CMAKE_CUDA_HOST_COMPILER什么时候设定为gcc 什么时候设定为nvcc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-CMAKE-CUDA-FLAGS"><span class="nav-text">关于 CMAKE_CUDA_FLAGS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A"><span class="nav-text">附录：</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="奔跑的IC"
      src="/images/zyd.gif">
  <p class="site-author-name" itemprop="name">奔跑的IC</p>
  <div class="site-description" itemprop="description">死磕牛角的IT农民工</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">174</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/cmake/7%20cmake%20%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zyd.gif">
      <meta itemprop="name" content="奔跑的IC">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="奔跑的IC">
      <meta itemprop="description" content="死磕牛角的IT农民工">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="7 cmake 综合示例 | 奔跑的IC">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          7 cmake 综合示例
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-12-01 18:13:45" itemprop="dateCreated datePublished" datetime="2024-12-01T18:13:45+08:00">2024-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cmake/" itemprop="url" rel="index"><span itemprop="name">cmake</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="7-cmake综合示例"><a href="#7-cmake综合示例" class="headerlink" title="7 cmake综合示例"></a>7 cmake综合示例</h1><p>比较简单的例子在“2 cmake简单示例”中介绍过了。这里使用一个综合的例子实现以下功能：</p>
<ol>
<li>cmake实现交叉编译和x86的编译（脚本传参实现区分）</li>
<li>使用参数“<a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/manual/cmake.1.html#cmdoption-cmake-D"><code>-DCMAKE_TOOLCHAIN_FILE</code></a>”实现工具链的配置</li>
<li>cmake实现交叉编译和x86编译cuda程序</li>
</ol>
<h2 id="1-文件结构"><a href="#1-文件结构" class="headerlink" title="1 文件结构"></a>1 文件结构</h2><p>具体的文件结构如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zyd@zyd:~/WorkSpace/zyd/note/cuda/code/chapter01$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── arm_qnx_toolchain.cmake</span><br><span class="line">├── Build</span><br><span class="line">├── build.sh</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── hello.cu</span><br><span class="line">├── Makefile_back</span><br><span class="line">└── x86_toolchain.cmake</span><br><span class="line"></span><br><span class="line">1 directory, 7 files</span><br></pre></td></tr></table></figure>
<ul>
<li>Build：cmake编译生成文件目录</li>
<li>build.sh：编译脚本 可以传入参数实现不同平台的编译</li>
<li>CMakeLists.txt：cmake命令依赖的文件</li>
<li>hello.cu：cuda源码文件</li>
<li>Makefile_back：之前的makfile文件，先在用cmake了，没什么用</li>
<li>arm_qnx_toolchain.cmake和x86_toolchain.cmake分别是用于交叉编译arm qnx和编译x86的工具链配置文件</li>
</ul>
<h2 id="2-文件内容"><a href="#2-文件内容" class="headerlink" title="2 文件内容"></a>2 文件内容</h2><h3 id="2-1-hello-cu"><a href="#2-1-hello-cu" class="headerlink" title="2.1 hello.cu"></a>2.1 hello.cu</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;../common/common.h&quot;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * A simple introduction to programming in CUDA. This program prints &quot;Hello</span><br><span class="line"> * World from GPU! from 10 CUDA threads running on the GPU.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">__global__ void helloFromGPU()</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;Hello World from GPU!\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;Hello World from CPU!\n&quot;);</span><br><span class="line"></span><br><span class="line">    helloFromGPU&lt;&lt;&lt;1, 10&gt;&gt;&gt;();</span><br><span class="line">    CHECK(cudaDeviceReset());</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-2-build-sh"><a href="#2-2-build-sh" class="headerlink" title="2.2 build.sh"></a>2.2 build.sh</h3><p>编译使用的是脚本<code>build.sh</code>因此先看一下这个文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">判断Build文件夹是否存在，不存在就创建。编译的程序就在这里</span></span><br><span class="line">if [ ! -d &quot;Build&quot; ];then</span><br><span class="line">    mkdir Build</span><br><span class="line">else</span><br><span class="line">    echo &quot;Build dir is exist&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd Build</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这里主要是设置了一些环境变量，交叉编译使用。具体使用参看arm_qnx_toolchain.cmake文件</span></span><br><span class="line">if [ &quot;$1&quot; != &quot;x86&quot; ] &amp;&amp;  [ &quot;$1&quot; != &quot;X86&quot; ]; then</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">设置交叉编译的环境变量 否则会出现<span class="string">&quot;The C compiler identification is unknown&quot;</span>的错误</span></span><br><span class="line">	QNX_BASE=/media/zyd/VisionPerception40Env/toolChainsQnx710</span><br><span class="line">	QNX_HOST=$&#123;QNX_BASE&#125;/host/linux/x86_64</span><br><span class="line">	QNX_TARGET=$&#123;QNX_BASE&#125;/target/qnx7</span><br><span class="line">	CUDA_DIR=$&#123;QNX_BASE&#125;/cudaSafe11.4</span><br><span class="line"></span><br><span class="line">	PATH=$&#123;QNX_HOST&#125;/usr/bin:$&#123;PATH&#125;</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">PATH=<span class="variable">$&#123;CUDA_DIR&#125;</span>/bin:<span class="variable">$&#123;PATH&#125;</span></span></span><br><span class="line"></span><br><span class="line">	export PATH QNX_BASE QNX_HOST QNX_TARGET CUDA_DIR</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不同的参数配置不同的工具链 -DCMAKE_TOOLCHAIN_FILE参数指定</span></span><br><span class="line">if [ &quot;$1&quot; = &quot;x86&quot; ] ||  [ &quot;$2&quot; = &quot;x86&quot; ]; then</span><br><span class="line">	cmake -DARCH_X86=1 -DCMAKE_TOOLCHAIN_FILE=../x86_toolchain.cmake .. &amp;&amp; make</span><br><span class="line">else</span><br><span class="line">	cmake -DCMAKE_TOOLCHAIN_FILE=../arm_qnx_toolchain.cmake .. &amp;&amp; make</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面脚本在Build目录下调用了<code>cmake ..</code>，因此下一步查看文件<code>CMakeLists.txt</code></p>
<h3 id="2-3-CMakeLists-txt"><a href="#2-3-CMakeLists-txt" class="headerlink" title="2.3 CMakeLists.txt"></a>2.3 CMakeLists.txt</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMake 最低版本号要求</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span> (VERSION <span class="number">3.16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印编译的具体过程信息</span></span><br><span class="line"><span class="comment"># set(CMAKE_VERBOSE_MAKEFILE ON) </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目信息</span></span><br><span class="line"><span class="keyword">project</span> (hello)</span><br><span class="line"><span class="comment"># project (hello LANGUAGES CUDA CXX)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 功能类似与project (hello LANGUAGES CUDA)</span></span><br><span class="line"><span class="comment"># Enables support for the named languages in CMake</span></span><br><span class="line"><span class="keyword">enable_language</span>(CUDA)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定头文件目录 PROJECT_SOURCE_DIR: 当前工程的源码路径</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(../common)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># include_directories($ENV&#123;QNX_BASE&#125;/target/qnx7/usr/include)</span></span><br><span class="line"><span class="comment"># include_directories($ENV&#123;CUDA_DIR&#125;/targets/aarch64-qnx/include)</span></span><br><span class="line"><span class="comment"># include_directories(/media/zyd/VisionPerception40Env/toolChainsQnx710/target/qnx7/usr/include)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># link_directories($ENV&#123;CUDA_DIR&#125;/target/qnx7/usr/lib)</span></span><br><span class="line"><span class="comment"># link_directories($ENV&#123;CUDA_DIR&#125;/targets/aarch64-qnx/lib)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找当前目录下的所有源文件</span></span><br><span class="line"><span class="comment"># 并将名称保存到 DIR_SRCS 变量</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(./ DIR_SRCS)</span><br><span class="line"><span class="comment"># message(&quot;DIR_SRCS is $ENV&#123;DIR_SRCS&#125;&quot;)</span></span><br><span class="line"><span class="comment"># 添加 src 子目录</span></span><br><span class="line"><span class="comment"># add_subdirectory(src)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定生成目标</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">DEFINED</span> ARCH_X86)</span><br><span class="line">	<span class="keyword">set</span>(PROJECT_NAME <span class="string">&quot;helloX86&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">	<span class="keyword">set</span>(PROJECT_NAME <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span> ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;DIR_SRCS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加链接库</span></span><br><span class="line"><span class="comment"># target_link_libraries(hello fun)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于需要编译cuda程序，因此需要设定<code>enable_language(CUDA)</code>，这个也可以使用<code>project (hello LANGUAGES CUDA)</code>来替代。</p>
<p>因为需要编译为两个平台，一个交叉编译一个本地PC编译，在<code>build.sh</code>中指定了cmake参数<code>-DCMAKE_TOOLCHAIN_FILE</code>来配置工具链。下面就看一下两个工具链的配置文件arm_qnx_toolchain.cmake和x86_toolchain.cmake</p>
<h3 id="2-4-arm-qnx-toolchain-cmake"><a href="#2-4-arm-qnx-toolchain-cmake" class="headerlink" title="2.4 arm_qnx_toolchain.cmake"></a>2.4 arm_qnx_toolchain.cmake</h3><p>先看一下交叉编译工具链的配置，参考<a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#id8">cmake-toolchains(7)</a></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要为其生成CMake的操作系统的名称</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_SYSTEM_NAME QNX)</span><br><span class="line"><span class="comment"># 目标体系结构的CMake标识符。</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_SYSTEM_PROCESSOR aarch64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置交叉编译工具链gcc和g++</span></span><br><span class="line"><span class="keyword">set</span>(QNX_HOST <span class="string">&quot;$ENV&#123;QNX_HOST&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_C_COMPILER <span class="variable">$&#123;QNX_HOST&#125;</span>/usr/bin/aarch64-unknown-nto-qnx7.<span class="number">1.0</span>-gcc)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_COMPILER <span class="variable">$&#123;QNX_HOST&#125;</span>/usr/bin/aarch64-unknown-nto-qnx7.<span class="number">1.0</span>-g++)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CUDA_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置cuda的编译工具链nvcc</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CUDA_COMPILER <span class="string">&quot;$ENV&#123;QNX_BASE&#125;/cudaSafe11.4/bin/nvcc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># cuda的目标架构</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> CMAKE_CUDA_ARCHITECTURES)</span><br><span class="line">  <span class="keyword">set</span>(CMAKE_CUDA_ARCHITECTURES <span class="number">61</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># set(CMAKE_SYSROOT $ENV&#123;QNX_TARGET&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMAKE_CUDA_HOST_COMPILER会选择编译CUDA语言文件的主机代码时要使用的编译器可执行文件。这映射到nvcc-ccbin选项</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CUDA_HOST_COMPILER <span class="string">&quot;$&#123;QNX_HOST&#125;/usr/bin/aarch64-unknown-nto-qnx7.1.0-g++&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>比较关键的几个点</p>
<ul>
<li><p><code>CMAKE_C_COMPILER</code>和<code>CMAKE_CXX_COMPILER</code>是设置交叉编译工具链gcc和g++的路经</p>
</li>
<li><p><code>CMAKE_CUDA_COMPILER</code>配置<code>.cu</code>GPU的编译工具链<code>nvcc</code>的路经</p>
</li>
<li><p><code>CMAKE_CUDA_STANDARD</code>设定CUDA标准</p>
</li>
<li><p><code>CMAKE_CUDA_ARCHITECTURES</code>设定GPU的架构</p>
</li>
<li><p><code>CMAKE_CUDA_HOST_COMPILER</code>需要设定为交叉编译工具g++的路经。如果不设定这一个会出现以下的类似错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">zyd@zyd:~/WorkSpace/zyd/note/cuda/code/chapter01$ ./build.sh</span><br><span class="line">-- The C compiler identification is GNU 8.3.0</span><br><span class="line">-- The CXX compiler identification is GNU 8.3.0</span><br><span class="line">-- Check for working C compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-gcc</span><br><span class="line">-- Check for working C compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-gcc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-g++</span><br><span class="line">-- Check for working CXX compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-g++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- The CUDA compiler identification is unknown</span><br><span class="line">-- Check for working CUDA compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/cudaSafe11.4/bin/nvcc</span><br><span class="line">-- Check for working CUDA compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/cudaSafe11.4/bin/nvcc -- broken</span><br><span class="line">CMake Error at /usr/local/share/cmake-3.16/Modules/CMakeTestCUDACompiler.cmake:46 (message):</span><br><span class="line">  The CUDA compiler</span><br><span class="line"></span><br><span class="line">    &quot;/media/zyd/VisionPerception40Env/toolChainsQnx710/cudaSafe11.4/bin/nvcc&quot;</span><br><span class="line"></span><br><span class="line">  is not able to compile a simple test program.</span><br><span class="line"></span><br><span class="line">  It fails with the following output:</span><br><span class="line"></span><br><span class="line">    Change Dir: /home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build/CMakeFiles/CMakeTmp</span><br><span class="line">    </span><br><span class="line">    Run Build Command(s):/media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/make cmTC_612bd/fast &amp;&amp; /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/make -f CMakeFiles/cmTC_612bd.dir/build.make CMakeFiles/cmTC_612bd.dir/build</span><br><span class="line">    make[1]: Entering directory &#x27;/home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build/CMakeFiles/CMakeTmp&#x27;</span><br><span class="line">    Building CUDA object CMakeFiles/cmTC_612bd.dir/main.cu.o</span><br><span class="line">    /media/zyd/VisionPerception40Env/toolChainsQnx710/cudaSafe11.4/bin/nvcc     -x cu -c /home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build/CMakeFiles/CMakeTmp/main.cu -o CMakeFiles/cmTC_612bd.dir/main.cu.o</span><br><span class="line">    cc1plus: fatal error: cuda_runtime.h: No such file or directory</span><br><span class="line">    compilation terminated.</span><br><span class="line">    CMakeFiles/cmTC_612bd.dir/build.make:65: recipe for target &#x27;CMakeFiles/cmTC_612bd.dir/main.cu.o&#x27; failed</span><br><span class="line">    make[1]: *** [CMakeFiles/cmTC_612bd.dir/main.cu.o] Error 1</span><br><span class="line">    make[1]: Leaving directory &#x27;/home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build/CMakeFiles/CMakeTmp&#x27;</span><br><span class="line">    Makefile:121: recipe for target &#x27;cmTC_612bd/fast&#x27; failed</span><br><span class="line">    make: *** [cmTC_612bd/fast] Error 2</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  CMake will not be able to correctly generate this project.</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:13 (enable_language)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also &quot;/home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build/CMakeFiles/CMakeOutput.log&quot;.</span><br><span class="line">See also &quot;/home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build/CMakeFiles/CMakeError.log&quot;.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-5-x86-toolchain-cmake"><a href="#2-5-x86-toolchain-cmake" class="headerlink" title="2.5 x86_toolchain.cmake"></a>2.5 x86_toolchain.cmake</h3><p>这个相对与交叉编译工具链的比较简单</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_CUDA_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> CMAKE_CUDA_ARCHITECTURES)</span><br><span class="line">  <span class="keyword">set</span>(CMAKE_CUDA_ARCHITECTURES <span class="number">61</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-编译"><a href="#3-编译" class="headerlink" title="3 编译"></a>3 编译</h2><p>交叉编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">zyd@zyd:~/WorkSpace/zyd/note/cuda/code/chapter01$ ./build.sh</span><br><span class="line">-- The C compiler identification is GNU 8.3.0</span><br><span class="line">-- The CXX compiler identification is GNU 8.3.0</span><br><span class="line">-- Check for working C compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-gcc</span><br><span class="line">-- Check for working C compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-gcc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-g++</span><br><span class="line">-- Check for working CXX compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/host/linux/x86_64/usr/bin/aarch64-unknown-nto-qnx7.1.0-g++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- The CUDA compiler identification is NVIDIA 11.4.207</span><br><span class="line">-- Check for working CUDA compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/cudaSafe11.4/bin/nvcc</span><br><span class="line">-- Check for working CUDA compiler: /media/zyd/VisionPerception40Env/toolChainsQnx710/cudaSafe11.4/bin/nvcc -- works</span><br><span class="line">-- Detecting CUDA compiler ABI info</span><br><span class="line">-- Detecting CUDA compiler ABI info - done</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build</span><br><span class="line">Scanning dependencies of target hello</span><br><span class="line">[ 50%] Building CUDA object CMakeFiles/hello.dir/hello.cu.o</span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Linking CUDA executable hello</span></span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Built target hello</span></span><br></pre></td></tr></table></figure>
<p>编译PC版版本，（切换版本编译需要删除Build目录内容）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">zyd@zyd:~/WorkSpace/zyd/note/cuda/code/chapter01$ ./build.sh x86</span><br><span class="line">-- The C compiler identification is GNU 9.4.0</span><br><span class="line">-- The CXX compiler identification is GNU 9.4.0</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- The CUDA compiler identification is NVIDIA 11.8.89</span><br><span class="line">-- Check for working CUDA compiler: /usr/local/cuda/bin/nvcc</span><br><span class="line">-- Check for working CUDA compiler: /usr/local/cuda/bin/nvcc -- works</span><br><span class="line">-- Detecting CUDA compiler ABI info</span><br><span class="line">-- Detecting CUDA compiler ABI info - done</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">CMake Warning:</span><br><span class="line">  Manually-specified variables were not used by the project:</span><br><span class="line"></span><br><span class="line">    ARCH_X86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Build files have been written to: /home/zyd/WorkSpace/zyd/note/cuda/code/chapter01/Build</span><br><span class="line">Scanning dependencies of target helloX86</span><br><span class="line">[ 50%] Building CUDA object CMakeFiles/helloX86.dir/hello.cu.o</span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Linking CUDA executable helloX86</span></span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Built target helloX86</span></span><br></pre></td></tr></table></figure>
<h2 id="4-cuda和c-混合编译"><a href="#4-cuda和c-混合编译" class="headerlink" title="4 cuda和c++混合编译"></a>4 cuda和c++混合编译</h2><p>修改上面的hello.cu，分为一个main.cpp和hello.cu 。在一个文件夹内。cmake文件都不需要修改，只修改源码部分如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── arm_qnx_toolchain.cmake</span><br><span class="line">├── Build</span><br><span class="line">├── build.sh</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── hello.cu</span><br><span class="line">├── main.cpp</span><br><span class="line">├── Makefile_back</span><br><span class="line">└── x86_toolchain.cmake</span><br><span class="line"></span><br><span class="line">1 directory, 7 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>main.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">helloCPU</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello from CPU!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">helloFromGPU</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    helloCPU();</span><br><span class="line">    helloFromGPU();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hello.cu</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">__global__ void helloGPU() &#123;</span><br><span class="line">    printf(&quot;Hello from GPU!\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void helloFromGPU() &#123;</span><br><span class="line">    helloGPU&lt;&lt;&lt;1, 10&gt;&gt;&gt;();</span><br><span class="line">    cudaDeviceSynchronize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-与GPT的对话"><a href="#5-与GPT的对话" class="headerlink" title="5 与GPT的对话"></a>5 与GPT的对话</h2><p>cmake的值令比较多，但是之间的相互关系没弄太明白。还是问了GPT才有一个比较直观的了解。</p>
<h3 id="编写一个cuda-的cmake文件"><a href="#编写一个cuda-的cmake文件" class="headerlink" title="编写一个cuda 的cmake文件"></a>编写一个cuda 的cmake文件</h3><p>2023/8/25 13:47:01</p>
<p>当编写一个 CUDA 的 CMake 文件时，我们需要确保正确配置以下内容：</p>
<ol>
<li>检查 CUDA 是否可用；</li>
<li>设置工程名称和最低要求的 CMake 版本；</li>
<li>添加源文件、头文件和其他依赖项；</li>
<li>配置编译选项和链接选项；</li>
<li>生成目标文件。</li>
</ol>
<p>下面是一个示例 CUDA CMake 文件的基本结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line">cmake_minimum_required(VERSION 3.18 FATAL_ERROR)</span><br><span class="line">project(MyCudaProject)</span><br><span class="line"></span><br><span class="line"># 检查 CUDA 是否可用</span><br><span class="line">find_package(CUDA REQUIRED)</span><br><span class="line"></span><br><span class="line"># 设置 CUDA 架构类型（可根据需要更改）</span><br><span class="line">set(CUDA_ARCHITECTURES &quot;60&quot;)</span><br><span class="line"></span><br><span class="line"># 添加源文件和头文件</span><br><span class="line">set(SOURCES</span><br><span class="line">    main.cu</span><br><span class="line">)</span><br><span class="line">set(HEADERS</span><br><span class="line">    kernel.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -arch=$&#123;CUDA_ARCHITECTURES&#125;&quot;)</span><br><span class="line">set(CMAKE_CUDA_STANDARD 14)</span><br><span class="line"></span><br><span class="line"># 添加其他依赖项（如果有）</span><br><span class="line"># find_package(&lt;package_name&gt; REQUIRED)</span><br><span class="line"></span><br><span class="line"># 生成目标文件</span><br><span class="line">add_executable(MyCudaExecutable $&#123;SOURCES&#125; $&#123;HEADERS&#125;)</span><br><span class="line"></span><br><span class="line"># 链接 CUDA 库和其他依赖项（如果有）</span><br><span class="line">target_link_libraries(MyCudaExecutable CUDA::cudart)</span><br></pre></td></tr></table></figure>
<p>请注意，在以上示例中，我们使用了 <code>find_package(CUDA REQUIRED)</code> 来检查 CUDA 是否可用。然而，自 CUDA 11.3 起，NVIDIA 建议使用新的 <code>find_package(CUDAToolkit REQUIRED)</code> 来代替旧的 <code>find_package(CUDA REQUIRED)</code>。</p>
<p>此外，还需要根据您的项目需求进行适当的修改。您可以在 <code>SOURCES</code> 和 <code>HEADERS</code> 中添加或删除源文件和头文件，并在 <code>CMAKE_CUDA_FLAGS</code> 中配置适当的编译选项。</p>
<p>最后，运行 CMake 生成您的构建系统所需的 Makefile 或 Visual Studio 工程文件等。</p>
<p>2023/8/25 13:47:18</p>
<h3 id="修改为交叉编译的版本"><a href="#修改为交叉编译的版本" class="headerlink" title="修改为交叉编译的版本"></a>修改为交叉编译的版本</h3><p>2023/8/25 13:47:35</p>
<p>若要使用 CMake 进行 CUDA 的交叉编译，您需要提供交叉编译工具链，并根据目标平台的架构和配置进行相应的设置。下面是一个示例 CUDA 交叉编译的 CMake 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line">cmake_minimum_required(VERSION 3.18 FATAL_ERROR)</span><br><span class="line">project(MyCudaProject)</span><br><span class="line"></span><br><span class="line"># 设置交叉编译工具链</span><br><span class="line">set(CMAKE_C_COMPILER /path/to/cross-compiler/bin/gcc)</span><br><span class="line">set(CMAKE_CXX_COMPILER /path/to/cross-compiler/bin/g++)</span><br><span class="line"></span><br><span class="line"># 检查 CUDA 是否可用</span><br><span class="line">find_package(CUDA REQUIRED)</span><br><span class="line"></span><br><span class="line"># 设置 CUDA 架构类型（可根据需要更改）</span><br><span class="line">set(CUDA_ARCHITECTURES &quot;60&quot;)</span><br><span class="line"></span><br><span class="line"># 添加源文件和头文件</span><br><span class="line">set(SOURCES</span><br><span class="line">    main.cu</span><br><span class="line">)</span><br><span class="line">set(HEADERS</span><br><span class="line">    kernel.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -arch=$&#123;CUDA_ARCHITECTURES&#125;&quot;)</span><br><span class="line">set(CMAKE_CUDA_STANDARD 14)</span><br><span class="line"></span><br><span class="line"># 添加其他依赖项（如果有）</span><br><span class="line"># find_package(&lt;package_name&gt; REQUIRED)</span><br><span class="line"></span><br><span class="line"># 生成目标文件</span><br><span class="line">add_executable(MyCudaExecutable $&#123;SOURCES&#125; $&#123;HEADERS&#125;)</span><br><span class="line"></span><br><span class="line"># 链接 CUDA 库和其他依赖项（如果有）</span><br><span class="line">target_link_libraries(MyCudaExecutable CUDA::cudart)</span><br></pre></td></tr></table></figure>
<p>在上述示例中，您需要将 <code>/path/to/cross-compiler</code> 替换为实际的交叉编译工具链路径，以确保 CMake 使用正确的交叉编译器。</p>
<p>请记住，交叉编译可能需要更多的配置和调整，具体取决于您的目标平台和环境。因此，以上示例仅供参考，您需要根据自己的需求进行相应的修改。</p>
<p>同样，在生成构建系统时，请使用适当的交叉编译命令和参数。例如，使用 <code>cmake -DCMAKE_TOOLCHAIN_FILE=/path/to/toolchain.cmake ..</code> 来指定交叉编译工具链文件。</p>
<p>2023/8/25 13:48:21</p>
<h3 id="什么时候需要设定-CMAKE-CUDA-HOST-COMPILER-参数"><a href="#什么时候需要设定-CMAKE-CUDA-HOST-COMPILER-参数" class="headerlink" title="什么时候需要设定 CMAKE_CUDA_HOST_COMPILER 参数"></a>什么时候需要设定 CMAKE_CUDA_HOST_COMPILER 参数</h3><p>2023/8/25 13:48:45</p>
<p>在某些情况下，您可能需要设置 <code>CMAKE_CUDA_HOST_COMPILER</code> 参数。这个参数用于指定在主机上编译 CUDA 源文件时要使用的编译器。</p>
<p>通常，如果您正在进行交叉编译或使用不同于默认值的编译器，则需要设置 <code>CMAKE_CUDA_HOST_COMPILER</code>。下面是一些常见的情况：</p>
<ol>
<li>交叉编译：当您在一个平台上开发 CUDA 代码，但希望将其运行在另一个平台时，您需要使用交叉编译工具链，并设置 <code>CMAKE_CUDA_HOST_COMPILER</code> 来指定正确的主机编译器。这样可以确保在主机上编译 CUDA 源文件时使用交叉编译器而不是本地编译器。</li>
<li>特定编译器要求：CUDA 可能与特定版本的编译器相关联。如果您希望使用不同于默认主机编译器的特定编译器版本，您可以通过设置 <code>CMAKE_CUDA_HOST_COMPILER</code> 参数来指定所需的编译器。</li>
</ol>
<p>以下是一个示例，展示了如何设置 <code>CMAKE_CUDA_HOST_COMPILER</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line">cmake_minimum_required(VERSION 3.18 FATAL_ERROR)</span><br><span class="line">project(MyCudaProject)</span><br><span class="line"></span><br><span class="line"># 设置交叉编译工具链和主机编译器</span><br><span class="line">set(CMAKE_C_COMPILER /path/to/cross-compiler/bin/gcc)</span><br><span class="line">set(CMAKE_CXX_COMPILER /path/to/cross-compiler/bin/g++)</span><br><span class="line">set(CMAKE_CUDA_HOST_COMPILER /path/to/cross-compiler/bin/gcc)</span><br><span class="line"></span><br><span class="line"># 检查 CUDA 是否可用</span><br><span class="line">find_package(CUDA REQUIRED)</span><br><span class="line"></span><br><span class="line"># 其他配置和生成目标文件的步骤...</span><br></pre></td></tr></table></figure>
<p>在上述示例中，我们设置了 <code>CMAKE_CUDA_HOST_COMPILER</code> 参数为交叉编译工具链中的 <code>gcc</code> 编译器路径。这样，在主机上编译 CUDA 源文件时，CMake 将使用指定的编译器。</p>
<p>请注意，是否需要设置 <code>CMAKE_CUDA_HOST_COMPILER</code> 取决于您的具体需求和环境。大多数情况下，默认的主机编译器即可正常工作，无需手动设置该参数。</p>
<p>2023/8/25 13:50:40</p>
<h3 id="不使用-find-package"><a href="#不使用-find-package" class="headerlink" title="不使用 find_package"></a>不使用 find_package</h3><p>不使用 find_package 重新编写一个交叉编译 cuda 的toolchain.cmake 和对应的cmakelist文件</p>
<p>2023/8/25 13:52:20</p>
<p>当您不使用 <code>find_package</code> 命令时，可以通过编写自定义的工具链文件 <code>toolchain.cmake</code> 和相应的 CMakeLists.txt 文件来进行交叉编译 CUDA。</p>
<p>首先，创建一个名为 <code>toolchain.cmake</code> 的文件，并在其中定义交叉编译所需的工具链路径和选项。以下是一个示例 <code>toolchain.cmake</code> 文件的结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line"># 设置交叉编译工具链</span><br><span class="line">set(CMAKE_SYSTEM_NAME Linux)  # 目标系统名称</span><br><span class="line">set(CMAKE_C_COMPILER /path/to/cross-compiler/bin/gcc)  # C 编译器路径</span><br><span class="line">set(CMAKE_CXX_COMPILER /path/to/cross-compiler/bin/g++)  # C++ 编译器路径</span><br><span class="line"></span><br><span class="line"># 设置 CUDA 相关变量</span><br><span class="line">set(CUDA_TOOLKIT_ROOT_DIR /path/to/cuda/toolkit)  # CUDA 工具包路径</span><br><span class="line">set(CMAKE_CUDA_HOST_COMPILER /path/to/cross-compiler/bin/cpp)  # 主机编译器路径</span><br><span class="line">set(CMAKE_CUDA_ARCHITECTURES &quot;60&quot;)  # CUDA 架构类型</span><br><span class="line"></span><br><span class="line"># 其他交叉编译选项和配置...</span><br></pre></td></tr></table></figure>
<p>请根据您的实际情况修改上述文件中的路径和选项，确保它们与您的交叉编译环境一致。</p>
<p>接下来，创建一个名为 <code>CMakeLists.txt</code> 的文件，用于设置项目的源文件、目标文件和其他构建相关的信息。以下是一个示例 <code>CMakeLists.txt</code> 文件的基本结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line">cmake_minimum_required(VERSION 3.18 FATAL_ERROR)</span><br><span class="line">project(MyCudaProject)</span><br><span class="line"></span><br><span class="line"># 加载交叉编译工具链</span><br><span class="line">set(CMAKE_TOOLCHAIN_FILE /path/to/toolchain.cmake)</span><br><span class="line"></span><br><span class="line"># 添加源文件和头文件</span><br><span class="line">set(SOURCES</span><br><span class="line">    main.cu</span><br><span class="line">)</span><br><span class="line">set(HEADERS</span><br><span class="line">    kernel.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CUDA_STANDARD 14)</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -O3&quot;)  # 示例：添加其他编译选项</span><br><span class="line"></span><br><span class="line"># 添加其他依赖项（如果有）</span><br><span class="line"># find_package(&lt;package_name&gt; REQUIRED)</span><br><span class="line"></span><br><span class="line"># 生成目标文件</span><br><span class="line">add_executable(MyCudaExecutable $&#123;SOURCES&#125; $&#123;HEADERS&#125;)</span><br><span class="line"></span><br><span class="line"># 链接 CUDA 库和其他依赖项（如果有）</span><br><span class="line">target_link_libraries(MyCudaExecutable CUDA::cudart)</span><br></pre></td></tr></table></figure>
<p>在上述示例中，我们通过 <code>set(CMAKE_TOOLCHAIN_FILE /path/to/toolchain.cmake)</code> 指定了自定义的工具链文件路径。</p>
<p>请注意，示例中的路径 <code>/path/to/toolchain.cmake</code> 需要替换为您实际的 <code>toolchain.cmake</code> 文件路径。</p>
<p>此外，您还需要根据您的项目需求进行适当的修改。您可以在 <code>SOURCES</code> 和 <code>HEADERS</code> 中添加或删除源文件和头文件，并在 <code>CMAKE_CUDA_FLAGS</code> 中配置适当的编译选项。</p>
<p>最后，运行 CMake 生成您的构建系统所需的 Makefile 或 Visual Studio 工程文件等。使用以下命令运行 CMake：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br><span class="line">cmake /path/to/source/directory</span><br></pre></td></tr></table></figure>
<p>确保将 <code>/path/to/source/directory</code> 替换为包含 <code>CMakeLists.txt</code> 文件的实际源代码目录路径。</p>
<p>2023/8/25 13:53:04</p>
<h3 id="添加一些-其他交叉编译选项和配置-的配置"><a href="#添加一些-其他交叉编译选项和配置-的配置" class="headerlink" title="添加一些 其他交叉编译选项和配置 的配置"></a>添加一些 其他交叉编译选项和配置 的配置</h3><p>2023/8/25 13:53:53</p>
<p>当进行交叉编译 CUDA 时，您可能需要添加一些其他的交叉编译选项和配置。这些选项和配置将根据您的目标平台和项目需求而有所不同。以下是一个示例 <code>toolchain.cmake</code> 文件和对应的 <code>CMakeLists.txt</code> 文件，演示了如何添加其他交叉编译选项和配置：</p>
<p><strong>toolchain.cmake:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line"># 设置交叉编译工具链</span><br><span class="line">set(CMAKE_SYSTEM_NAME Linux)  # 目标系统名称</span><br><span class="line">set(CMAKE_C_COMPILER /path/to/cross-compiler/bin/gcc)  # C 编译器路径</span><br><span class="line">set(CMAKE_CXX_COMPILER /path/to/cross-compiler/bin/g++)  # C++ 编译器路径</span><br><span class="line"></span><br><span class="line"># 设置 CUDA 相关变量</span><br><span class="line">set(CUDA_TOOLKIT_ROOT_DIR /path/to/cuda/toolkit)  # CUDA 工具包路径</span><br><span class="line">set(CMAKE_CUDA_HOST_COMPILER /path/to/cross-compiler/bin/cpp)  # 主机编译器路径</span><br><span class="line">set(CMAKE_CUDA_ARCHITECTURES &quot;60&quot;)  # CUDA 架构类型</span><br><span class="line"></span><br><span class="line"># 其他交叉编译选项和配置</span><br><span class="line">set(CMAKE_EXE_LINKER_FLAGS &quot;-static-libgcc -static-libstdc++&quot;)  # 静态链接标准库</span><br><span class="line">set(CMAKE_SHARED_LIBRARY_LINK_C_FLAGS &quot;&quot;)  # 禁用共享库链接</span><br><span class="line">set(CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS &quot;&quot;)  # 禁用共享库链接</span><br></pre></td></tr></table></figure>
<p><strong>CMakeLists.txt:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line">cmake_minimum_required(VERSION 3.18 FATAL_ERROR)</span><br><span class="line">project(MyCudaProject)</span><br><span class="line"></span><br><span class="line"># 加载交叉编译工具链</span><br><span class="line">set(CMAKE_TOOLCHAIN_FILE /path/to/toolchain.cmake)</span><br><span class="line"></span><br><span class="line"># 添加源文件和头文件</span><br><span class="line">set(SOURCES</span><br><span class="line">    main.cu</span><br><span class="line">)</span><br><span class="line">set(HEADERS</span><br><span class="line">    kernel.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 配置编译选项</span><br><span class="line">set(CMAKE_CUDA_STANDARD 14)</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -O3&quot;)  # 示例：添加其他编译选项</span><br><span class="line"></span><br><span class="line"># 添加其他依赖项（如果有）</span><br><span class="line"># find_package(&lt;package_name&gt; REQUIRED)</span><br><span class="line"></span><br><span class="line"># 生成目标文件</span><br><span class="line">add_executable(MyCudaExecutable $&#123;SOURCES&#125; $&#123;HEADERS&#125;)</span><br><span class="line"></span><br><span class="line"># 链接 CUDA 库和其他依赖项（如果有）</span><br><span class="line">target_link_libraries(MyCudaExecutable CUDA::cudart)</span><br></pre></td></tr></table></figure>
<p>在上述示例中，我们通过在 <code>toolchain.cmake</code> 文件中设置以下内容来添加其他交叉编译选项和配置：</p>
<ul>
<li><code>CMAKE_EXE_LINKER_FLAGS</code>：用于设置链接器的选项。在示例中，我们使用 <code>-static-libgcc -static-libstdc++</code> 来静态链接 C 和 C++ 的标准库。</li>
<li><code>CMAKE_SHARED_LIBRARY_LINK_C_FLAGS</code> 和 <code>CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS</code>：用于禁用共享库的链接。这样可以确保只生成可执行文件而不是共享库。</li>
</ul>
<p>您可以根据自己的需求修改这些选项和配置。请注意，具体的选项和配置可能因交叉编译平台和环境而异。因此，上述示例仅供参考，您需要根据自己的情况进行相应的修改。</p>
<h3 id="find-package-和enable-language-用哪一个？"><a href="#find-package-和enable-language-用哪一个？" class="headerlink" title="find_package 和enable_language 用哪一个？"></a>find_package 和enable_language 用哪一个？</h3><p>2023/8/25 14:00:36</p>
<p><code>find_package</code> 和 <code>enable_language</code> 是用于不同目的的 CMake 命令，具体取决于您的需求。</p>
<ul>
<li><code>find_package</code> 用于查找和配置外部软件包或库。它通过在系统上搜索指定软件包的头文件、库文件或配置文件来确定软件包是否可用，并据此设置相关的变量和选项。这通常用于自动检测和配置项目所需的依赖项。例如，使用 <code>find_package(CUDA REQUIRED)</code> 可以查找 CUDA 并将其配置为项目的依赖项。</li>
<li><code>enable_language</code> 用于启用特定的编程语言支持。它告诉 CMake 在构建过程中启用指定的编程语言。默认情况下，CMake 已经启用了常见的编程语言，如 C 和 C++。但对于某些较新或非常见的编程语言，可能需要显式地使用 <code>enable_language</code> 命令来启用它们。例如，使用 <code>enable_language(CUDA)</code> 可以启用 CUDA 编程语言的支持。</li>
</ul>
<p>因此，这两个命令有着不同的作用和用途。如果您需要查找和配置外部软件包或库，以满足项目的依赖项，那么使用 <code>find_package</code> 是合适的选择。而如果您想要启用特定的编程语言支持，例如 CUDA，那么使用 <code>enable_language</code> 是更合适的</p>
<h3 id="交叉编译时-CMAKE-CUDA-HOST-COMPILER什么时候设定为gcc-什么时候设定为nvcc"><a href="#交叉编译时-CMAKE-CUDA-HOST-COMPILER什么时候设定为gcc-什么时候设定为nvcc" class="headerlink" title="交叉编译时 CMAKE_CUDA_HOST_COMPILER什么时候设定为gcc 什么时候设定为nvcc"></a>交叉编译时 CMAKE_CUDA_HOST_COMPILER什么时候设定为gcc 什么时候设定为nvcc</h3><p>2023/8/25 14:35:39</p>
<p>在进行交叉编译时，<code>CMAKE_CUDA_HOST_COMPILER</code>的设置取决于您要使用的工具链和目标平台。</p>
<p>当您希望使用GCC作为主机编译器时，将<code>CMAKE_CUDA_HOST_COMPILER</code>设置为GCC的路径。这通常在以下两种情况下发生：</p>
<ol>
<li>当您希望将CUDA代码与C/C++代码混合编译，并且主机端的代码由GCC编译器处理时，可以将<code>CMAKE_CUDA_HOST_COMPILER</code>设置为GCC的路径。</li>
<li>当您在交叉编译环境中使用GCC作为主机编译器时，例如在ARM架构上进行交叉编译，您需要将<code>CMAKE_CUDA_HOST_COMPILER</code>设置为适用于该交叉编译环境的GCC路径。</li>
</ol>
<p>相反地，当您希望将NVCC作为主机编译器时，将<code>CMAKE_CUDA_HOST_COMPILER</code>设置为nvcc的路径。这通常在以下情况下发生：</p>
<ol>
<li>当您只使用CUDA编程模型而没有主机端的C/C++代码时，您可以将<code>CMAKE_CUDA_HOST_COMPILER</code>设置为nvcc的路径。</li>
</ol>
<p>总之，<code>CMAKE_CUDA_HOST_COMPILER</code>的设置取决于您的需求和所使用的工具链。</p>
<h3 id="关于-CMAKE-CUDA-FLAGS"><a href="#关于-CMAKE-CUDA-FLAGS" class="headerlink" title="关于 CMAKE_CUDA_FLAGS"></a>关于 CMAKE_CUDA_FLAGS</h3><p><code>CMAKE_CUDA_FLAGS</code> 用于设置 NVIDIA CUDA 编译器（通常是 <code>nvcc</code>）的编译选项，它会影响 <code>nvcc</code> 命令的行为。这些选项被传递给 <code>nvcc</code> 编译器，以控制 CUDA 源代码的编译和链接行为。详细编译选项参考<a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html#nvcc-command-options">NVCC Command Options</a></p>
<p><code>CMAKE_CUDA_FLAGS</code> 变量用于设置 NVIDIA CUDA 编译器 <code>nvcc</code> 的编译选项。以下是一些常见选项及其含义，以及一个示例：</p>
<ol>
<li><strong>-arch=sm_xx</strong>：这个选项指定目标 GPU 的架构版本，其中 <code>xx</code> 是特定架构的版本号。例如，<code>-arch=sm_61</code> 表示目标 GPU 架构是 Compute Capability 6.1。</li>
<li><strong>-O[0-3]</strong>：设置优化级别。<code>-O0</code> 表示没有优化，<code>-O3</code> 表示最高级别的优化。</li>
<li><strong>-g</strong>：生成调试信息，以便使用调试器进行 CUDA 代码的调试。</li>
<li><strong>-G</strong>：生成 GPU 代码的调试信息，用于在 GPU 代码中进行调试。</li>
<li><strong>-Xcompiler</strong>：用于传递额外的编译器选项，这些选项将传递给主机 C/C++ 编译器。</li>
<li><strong>-Xptxas</strong>：传递给 ptxas 汇编器的选项，可以影响 PTX 代码生成。</li>
<li><strong>-Xlinker</strong>：用于传递给链接器的选项，用于配置链接过程。</li>
<li><strong>-lineinfo</strong>：生成 GPU 代码中的行号信息，以用于调试。</li>
<li><strong>-Xcudafe</strong>：传递给 cudafe（CUDA 前端编译器）的选项，可以影响 CUDA 源代码的处理。</li>
<li><strong>-rdc=true/false</strong>：启用或禁用 CUDA 动态并行性。设置为 <code>true</code> 允许动态并行性，<code>false</code> 禁用它。</li>
<li><strong>-Werror</strong>：将编译警告视为错误，强制开发人员修复所有警告。</li>
<li><strong>-lineinfo</strong>： 为设备代码生成行号信息。在使用Nsight Compute时非常有用</li>
<li><strong>-default-stream</strong>：<code>--default-stream</code> {<code>legacy</code>|<code>null</code>|<code>per-thread</code>} (<code>per-thread</code>) 。比较常用<code>--default-stream per-thread</code></li>
</ol>
<p>示例 <code>CMAKE_CUDA_FLAGS</code> 设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cmake</span><br><span class="line"># 设置 CUDA 架构为 Compute Capability 7.0</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -arch=sm_70&quot;)</span><br><span class="line"></span><br><span class="line"># 启用最高级别优化</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -O3&quot;)</span><br><span class="line"></span><br><span class="line"># 生成调试信息</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -g&quot;)</span><br><span class="line"></span><br><span class="line"># 将额外编译器选项传递给主机编译器</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -Xcompiler -fopenmp&quot;)</span><br><span class="line"></span><br><span class="line"># 生成 GPU 代码的调试信息</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -G&quot;)</span><br><span class="line"></span><br><span class="line"># 传递给链接器的选项</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -Xlinker -L/path/to/custom/lib&quot;)</span><br><span class="line"></span><br><span class="line"># 生成 GPU 代码中的行号信息</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -lineinfo&quot;)</span><br><span class="line"></span><br><span class="line"># 传递给 cudafe 的选项</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -Xcudafe --diag_suppress=esa_on_defaulted_function_ignored&quot;)</span><br><span class="line"></span><br><span class="line"># 启用 CUDA 动态并行性</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -rdc=true&quot;)</span><br><span class="line"></span><br><span class="line"># 将编译警告视为错误</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -Werror&quot;)</span><br><span class="line"></span><br><span class="line"># 设置编译选项 源代码反汇编视图用于在源代码和汇编指令级别显示内核的分析结果。为了能够查看内核源代码，您需要使用-lineinfo选项编译代码。如果不使用此编译器选项，则只显示反汇编视图。</span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -lineinfo&quot;)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CUDA_FLAGS &quot;$&#123;CMAKE_CUDA_FLAGS&#125; -G -g --default-stream per-thread&quot;)</span><br></pre></td></tr></table></figure>
<h1 id="附录："><a href="#附录：" class="headerlink" title="附录："></a>附录：</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html#nvcc-command-options">NVCC Command Options</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>奔跑的IC
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/cmake/7%20cmake%20%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B/" title="7 cmake 综合示例">http://example.com/cmake/7 cmake 综合示例/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C</a>
              <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a>
              <a href="/tags/GPU/" rel="tag"><i class="fa fa-tag"></i> GPU</a>
              <a href="/tags/cmake/" rel="tag"><i class="fa fa-tag"></i> cmake</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/cmake/5%20cmake%E5%AE%98%E6%96%B9%E7%A4%BA%E4%BE%8B/" rel="prev" title="5 cmake官方示例">
                  <i class="fa fa-chevron-left"></i> 5 cmake官方示例
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/cmake/cmake%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="cmake学习笔记">
                  cmake学习笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">奔跑的IC</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"zmurder","repo":"zmurder.github.io","client_id":"cf2343f27b6c29efe0bc","client_secret":"3268a1fa92706c7358d5421f88f76a0f7ada3188","admin_user":"zmurder","distraction_free_mode":true,"proxy":"https://strong-caramel-969805.netlify.app/github_access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"606e627d16b56b3ab4c74aaee5f4c7f8"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
