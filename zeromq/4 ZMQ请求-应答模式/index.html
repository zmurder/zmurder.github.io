<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8693861384618000"
     crossorigin="anonymous"></script>
  <meta name="msvalidate.01" content="7EC20DBC74B004C2782077570E15C280">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8693861384618000"
     crossorigin="anonymous"></script>
    <meta name="description" content="4 ZMQ请求-应答模式原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41453285&#x2F;article&#x2F;details&#x2F;106878960">
<meta property="og:type" content="article">
<meta property="og:title" content="4 ZMQ请求-应答模式">
<meta property="og:url" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/index.html">
<meta property="og:site_name" content="奔跑的IC">
<meta property="og:description" content="4 ZMQ请求-应答模式原文链接：https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41453285&#x2F;article&#x2F;details&#x2F;106878960">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170147864.png">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170305128.png">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170939959.png">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171026324.png">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171051462.png">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171239149.png">
<meta property="og:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171259512.png">
<meta property="article:published_time" content="2024-12-01T10:13:45.806Z">
<meta property="article:modified_time" content="2024-12-01T10:13:45.806Z">
<meta property="article:author" content="奔跑的IC">
<meta property="article:tag" content="git">
<meta property="article:tag" content="C">
<meta property="article:tag" content="zmq">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170147864.png">


<link rel="canonical" href="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/","path":"zeromq/4 ZMQ请求-应答模式/","title":"4 ZMQ请求-应答模式"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>4 ZMQ请求-应答模式 | 奔跑的IC</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">奔跑的IC</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-reorder fa-fw"></i>文章列表</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#4-ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F"><span class="nav-text">4 ZMQ请求-应答模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-REQ-REP%E5%A5%97%E6%8E%A5%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="nav-text">4.1 REQ-REP套接字类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-ZMQ-REQ"><span class="nav-text">4.1.1 ZMQ_REQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-ZMQ-REP"><span class="nav-text">4.1.2 ZMQ_REP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-DEALER-ROUTER%E5%A5%97%E6%8E%A5%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="nav-text">4.2 DEALER-ROUTER套接字类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-ZMQ-DEALER"><span class="nav-text">4.2.1 ZMQ_DEALER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-ZMQ-ROUTER"><span class="nav-text">4.2.2  ZMQ_ROUTER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E5%85%B1%E4%BA%AB%E9%98%9F%E5%88%97-%E4%BB%A3%E7%90%86"><span class="nav-text">4.2.3 共享队列&#x2F;代理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tips"><span class="nav-text">tips</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-text">附录</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="奔跑的IC"
      src="/images/zyd.gif">
  <p class="site-author-name" itemprop="name">奔跑的IC</p>
  <div class="site-description" itemprop="description">死磕牛角的IT农民工</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">147</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/zyd.gif">
      <meta itemprop="name" content="奔跑的IC">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="奔跑的IC">
      <meta itemprop="description" content="死磕牛角的IT农民工">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="4 ZMQ请求-应答模式 | 奔跑的IC">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          4 ZMQ请求-应答模式
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-12-01 18:13:45" itemprop="dateCreated datePublished" datetime="2024-12-01T18:13:45+08:00">2024-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/zeromq/" itemprop="url" rel="index"><span itemprop="name">zeromq</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="4-ZMQ请求-应答模式"><a href="#4-ZMQ请求-应答模式" class="headerlink" title="4 ZMQ请求-应答模式"></a>4 ZMQ请求-应答模式</h1><p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/106878960">https://blog.csdn.net/qq_41453285/article/details/106878960</a></p>
<ul>
<li><p>请求-响应模式由<a target="_blank" rel="noopener" href="http://rfc.zeromq.org/spec:28正式定义">http://rfc.zeromq.org/spec:28正式定义</a></p>
</li>
<li><p>请求-应答模式应该是最常见的交互模式，如果连接之后，服务器终止，那么客户端也终止，从崩溃的过程中恢复不太容易</p>
</li>
<li><p>因此，做一个可靠的请求-应答模式很复杂，在很后面我们会有一部分系列文章介绍“可靠的请求-应答模式”</p>
</li>
<li><p>“请求-响应模型”支持的套接字类型有4种：</p>
<ul>
<li><p>ZMQ_REP</p>
</li>
<li><p>ZMQ_REQ</p>
</li>
<li><p>ZMQ_DEALER</p>
</li>
<li><p>ZMQ_ROUTER</p>
</li>
</ul>
</li>
</ul>
<h2 id="4-1-REQ-REP套接字类型"><a href="#4-1-REQ-REP套接字类型" class="headerlink" title="4.1 REQ-REP套接字类型"></a>4.1 REQ-REP套接字类型</h2><ul>
<li>请求-响应模式用于将请求<strong>从ZMQ_REQ客户端发送到一个或多个ZMQ_REP服务</strong>，并接收对每个发送的请求的后续答复</li>
<li><strong>REQ-REP套接字对是步调一致的。</strong>它们两者的次序必须有规则，不能同时发送或接收，否则无效果</li>
</ul>
<h3 id="4-1-1-ZMQ-REQ"><a href="#4-1-1-ZMQ-REQ" class="headerlink" title="4.1.1 ZMQ_REQ"></a>4.1.1 ZMQ_REQ</h3><ul>
<li>客户端使用ZMQ_REQ类型的套接字向服务发送请求并从服务接收答复</li>
<li>此套接字类型仅允许zmq_send(request)和后续zmq_recv(reply)调用交替序列。发送的每个请求都在所有服务中轮流轮询，并且收到的每个答复都与最后发出的请求匹配</li>
<li><p>如果没有可用的服务，则套接字上的任何发送操作都应阻塞，直到至少有一项服务可用为止。REQ套接字不会丢弃消息</p>
<p><strong>ZMQ_REQ特性摘要</strong> </p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>兼容的对等套接字</th>
<th>ZMQ_REP、ZMQ_ROUTER</th>
</tr>
</thead>
<tbody>
<tr>
<td>方向</td>
<td>双向</td>
</tr>
<tr>
<td>发送/接收模式</td>
<td>发送、接收、发送、接收……</td>
</tr>
<tr>
<td>入网路由策略</td>
<td>最后一位（Last peer）</td>
</tr>
<tr>
<td>外发路由策略</td>
<td>轮询</td>
</tr>
<tr>
<td>静音状态下的操作</td>
<td>阻塞</td>
</tr>
</tbody>
</table>
</div>
<h3 id="4-1-2-ZMQ-REP"><a href="#4-1-2-ZMQ-REP" class="headerlink" title="4.1.2 ZMQ_REP"></a>4.1.2 ZMQ_REP</h3><ul>
<li><p>服务使用ZMQ_REP类型的套接字来接收来自客户端的请求并向客户端发送回复</p>
</li>
<li><p>此套接字类型仅允许zmq_recv(request)和后续zmq_send(reply)调用的交替序列。接收到的每个请求都从</p>
<p>有客户端中公平排队，并且发送的每个回复都路由到发出最后一个请求的客户端</p>
</li>
<li><p>如果原始请求者不再存在，则答复将被静默丢弃</p>
<p><strong>ZMQ_REP特性摘要</strong> </p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>兼容的对等套接字</th>
<th>ZMQ_REQ、ZMQ_DEALER</th>
</tr>
</thead>
<tbody>
<tr>
<td>方向</td>
<td>双向</td>
</tr>
<tr>
<td>发送/接收模式</td>
<td>接收、发送、接收、发送……</td>
</tr>
<tr>
<td>入网路由策略</td>
<td>公平排队</td>
</tr>
<tr>
<td>外发路由策略</td>
<td>最后一位（Last peer）</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p><strong>演示案例如下：</strong></p>
<ul>
<li><p>服务端创建REP套接字，阻塞等待客户端消息的到达，当客户端有消息达到时给客户端回送“World”字符串</p>
</li>
<li><p>客户端创建REP套接字，向服务端发送字符串“Hello”，然后等待服务端回送消息</p>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170147864.png" class="" title="image-20230310170147864">
</li>
</ul>
</li>
</ul>
<p><strong>服务端代码如下：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/dongyusheng/csdn-code/blob/master/ZeroMQ/hwserver.c</span></span><br><span class="line"><span class="comment">// hwserver.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zmq.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 向socket发送数据, 数据为string</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br><span class="line"><span class="comment">// 从socket接收数据, 并将数据以字符串的形式返回</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.创建上下文</span></span><br><span class="line">    <span class="type">void</span> *context = zmq_ctx_new();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 2.创建、绑定套接字</span></span><br><span class="line">    <span class="type">void</span> *responder = zmq_socket(context, ZMQ_REP);</span><br><span class="line">    zmq_bind(responder, <span class="string">&quot;tcp://*:5555&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="comment">// 3.循环接收数据、发送数据</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4.接收数据</span></span><br><span class="line">        <span class="type">char</span> *request = s_recv(responder);</span><br><span class="line">        assert(request != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Request: %s\n&quot;</span>, request);</span><br><span class="line">        <span class="built_in">free</span>(request);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 休眠1秒再继续回复</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 5.回送数据</span></span><br><span class="line">        <span class="type">char</span> *reply = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">        rc = s_send(responder, reply);</span><br><span class="line">        assert(rc &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 6.关闭套接字、销毁上下文</span></span><br><span class="line">    zmq_close(responder);</span><br><span class="line">    zmq_ctx_destroy(context);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    </span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init_size(&amp;msg, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(zmq_msg_data(&amp;msg), <span class="built_in">string</span>, <span class="built_in">strlen</span>(<span class="built_in">string</span>));</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_send(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_recv(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span> = (<span class="type">char</span>*)<span class="built_in">malloc</span>(rc + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="built_in">string</span>, zmq_msg_data(&amp;msg), rc);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">string</span>[rc] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>客户端代码如下：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/dongyusheng/csdn-code/blob/master/ZeroMQ/hwclient.c</span></span><br><span class="line"><span class="comment">// hwclient.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zmq.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 向socket发送数据, 数据为string</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br><span class="line"><span class="comment">// 从socket接收数据, 并将数据以字符串的形式返回</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.创建上下文</span></span><br><span class="line">    <span class="type">void</span> *context = zmq_ctx_new();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 2.创建套接字、连接服务器</span></span><br><span class="line">    <span class="type">void</span> *requester = zmq_socket(context, ZMQ_REQ);</span><br><span class="line">    zmq_connect(requester, <span class="string">&quot;tcp://localhost:5555&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="comment">// 3.循环发送数据、接收数据</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4.发送数据</span></span><br><span class="line">        <span class="type">char</span> *request = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        rc = s_send(requester, request);</span><br><span class="line">        assert(rc &gt; <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 5.接收回复数据</span></span><br><span class="line">        <span class="type">char</span> *reply = s_recv(requester);</span><br><span class="line">        assert(reply != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Reply: %s\n&quot;</span>, reply);</span><br><span class="line">        <span class="built_in">free</span>(reply);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 6.关闭套接字、销毁上下文</span></span><br><span class="line">    zmq_close(requester);</span><br><span class="line">    zmq_ctx_destroy(context);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    </span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init_size(&amp;msg, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(zmq_msg_data(&amp;msg), <span class="built_in">string</span>, <span class="built_in">strlen</span>(<span class="built_in">string</span>));</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_send(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_recv(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span> = (<span class="type">char</span>*)<span class="built_in">malloc</span>(rc + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="built_in">string</span>, zmq_msg_data(&amp;msg), rc);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">string</span>[rc] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译并运行如下，</strong>左侧为服务端，右侧为客户端：</p>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170305128.png" class="" title="image-20230310170305128">
<h2 id="4-2-DEALER-ROUTER套接字类型"><a href="#4-2-DEALER-ROUTER套接字类型" class="headerlink" title="4.2 DEALER-ROUTER套接字类型"></a>4.2 DEALER-ROUTER套接字类型</h2><p>本文介绍“DEALER-ROUTER”的语法和代理演示案例，在后面的一个专题中我们将介绍如何使用“DEALER-ROUTER”来构建各种异步请求-应答流</p>
<h3 id="4-2-1-ZMQ-DEALER"><a href="#4-2-1-ZMQ-DEALER" class="headerlink" title="4.2.1 ZMQ_DEALER"></a><strong>4.2.1 ZMQ_DEALER</strong></h3><ul>
<li>ZMQ_DEALER类型的套接字是用于扩展“请求/应答”套接字的高级模式</li>
<li>发送消息时：当ZMQ_DEALER套接字由于已达到所有对等点的最高水位而进入静音状态时，或者如果根本没有任何对等点，则套接字上的任何zmq_send()操作都应阻塞，直到静音状态结束或至少一个对等方变得可以发送；消息不会被丢弃</li>
<li>接收消息时：发送的每条消息都是在所有连接的对等方之间进行轮询，并且收到的每条消息都是从所有连接的对等方进行公平排队的</li>
<li>将ZMQ_DEALER套接字连接到ZMQ_REP套接字时，发送的每个消息都必须包含一个空的消息部分，定界符以及一个或多个主体部分</li>
</ul>
<p><strong>ZMQ_DEALER特性摘要</strong> </p>
<div class="table-container">
<table>
<thead>
<tr>
<th>兼容的对等套接字</th>
<th>ZMQ_ROUTER、ZMQ_REP、ZMQ_DEALER</th>
</tr>
</thead>
<tbody>
<tr>
<td>方向</td>
<td>双向</td>
</tr>
<tr>
<td>发送/接收模式</td>
<td>无限制</td>
</tr>
<tr>
<td>入网路由策略</td>
<td>公平排队</td>
</tr>
<tr>
<td>外发路由策略</td>
<td>轮询</td>
</tr>
<tr>
<td>静音状态下的操作</td>
<td>阻塞</td>
</tr>
</tbody>
</table>
</div>
<h3 id="4-2-2-ZMQ-ROUTER"><a href="#4-2-2-ZMQ-ROUTER" class="headerlink" title="4.2.2  ZMQ_ROUTER"></a><strong>4.2.2  ZMQ_ROUTER</strong></h3><ul>
<li>ZMQ_ROUTER类型的套接字是用于扩展请求/答复套接字的高级套接字类型</li>
<li>当收到消息时：ZMQ_ROUTER套接字在将消息传递给应用程序之前，应在消息部分之前包含消息的始发对等方的路由ID。接收到的消息从所有连接的同级之间公平排队</li>
<li>发送消息时：<ul>
<li>ZMQ<em>ROUTER套接字应删除消息的第一部分，并使用它来确定消息应路由到的对等方的_routing id </em>。如果该对等点不再存在或从未存在，则该消息将被静默丢弃</li>
<li>但是，如果ZMQ_ROUTER_MANDATORY套接字选项设置为1，这两种情况下套接字都将失败并显示EHOSTUNREACH</li>
</ul>
</li>
<li>高水位标记影响：<ul>
<li>当ZMQ_ROUTER套接字由于达到所有同位体的高水位线而进入静音状态时，发送到该套接字的任何消息都将被丢弃，直到静音状态结束为止。同样，任何路由到已达到单个高水位标记的对等方的消息也将被丢弃</li>
<li>如果ZMQ_ROUTER_MANDATORY套接字选项设置为1，则在两种情况下套接字都应阻塞或返回EAGAIN</li>
</ul>
</li>
<li>ZMQ_ROUTER_MANDATORY套接字选项：<ul>
<li>当ZMQ_ROUTER套接字的ZMQ_ROUTER_MANDATORY标志设置为1时，套接字应在接收到来自一个或多个对等方的消息后生成ZMQ_POLLIN事件</li>
<li>同样，当至少一个消息可以发送给一个或多个对等方时，套接字将生成ZMQ_POLLOUT事件</li>
</ul>
</li>
<li>当ZMQ_REQ套接字连接到ZMQ_ROUTER套接字时，除了始发对等方的路由ID外，每个收到的消息都应包含一个空的定界符消息部分。因此，由应用程序看到的每个接收到的消息的整个结构变为：一个或多个路由ID部分，定界符部分，一个或多个主体部分。将回复发送到ZMQ_REQ套接字时，应用程序必须包括定界符部分</li>
</ul>
<p><strong>ZMQ_ROUTER特性摘要</strong> </p>
<div class="table-container">
<table>
<thead>
<tr>
<th>兼容的对等套接字</th>
<th>ZMQ_DEALER、ZMQ_REQ、ZMQ_ROUTER</th>
</tr>
</thead>
<tbody>
<tr>
<td>方向</td>
<td>双向</td>
</tr>
<tr>
<td>发送/接收模式</td>
<td>无限制</td>
</tr>
<tr>
<td>入网路由策略</td>
<td>公平排队</td>
</tr>
<tr>
<td>外发路由策略</td>
<td>看上面介绍</td>
</tr>
<tr>
<td>静音状态下的操作</td>
<td>丢弃（见上面介绍）</td>
</tr>
</tbody>
</table>
</div>
<h3 id="4-2-3-共享队列-代理"><a href="#4-2-3-共享队列-代理" class="headerlink" title="4.2.3 共享队列/代理"></a>4.2.3 共享队列/代理</h3><p>在“REP-REQ”的演示案例中，我们只有一个客户端和一个服务端进行交流。但是实际中，我们通常允许多个客户端与多个服务端之间相互交流<br>将多个客户端连接到多个服务器的方法有两种：<br>    方法①：将每个客户端都连接到多个服务端点<br>    方法②：使用代理</p>
<p>方法①：</p>
<ul>
<li>原理：一种是将每个客户端套接字连接到多个服务端点。REQ套接字随后会将请求发送到服务端上。比如说一个客户端连接了三个服务端点：A、B、C，之后发送请求R1、R4到服务A上，发送请求R2到服务B上、发送请求R3到服务C上（如下图所示）</li>
<li>对于这种设计来说，服务器属于静态部分，客户端属于动态部分，客户端的增减无所谓，但是服务器的增减确实致命的。假设现在有100个客户端都连接了服务器，如果此时新增了三台服务器，为了让客户端识别这新增的三台服务器，那么就需要将所有的客户端都停止重新配置然后再重新启动</li>
</ul>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310170939959.png" class="" title="image-20230310170939959">
<p>方法②：</p>
<ul>
<li><p>我们可以编写一个小型消息排队代理，使我们具备灵活性</p>
</li>
<li><p>原理：该代理绑定到了两个端点，一个用于客户端的前端（ZMQ_ROUTER），另一个用于服务的后端（ZMQ_DEALER）。然后带来使用zmq_poll()来轮询这两个套接字的活动，当有消息时，代理会将消息在两个套接字之间频繁地输送</p>
</li>
<li><p>该代理其实并不显式管理任何队列，其只负责消息的传送，ØMQ会自动将消息在每个套接字上进行排队</p>
</li>
<li><p>使用zmq_poll()配合DEALER-ROUTER：</p>
<ul>
<li>在上面我们使用REQ-REP套接字时，会有一个严格同步的请求-响应对话，就是必须客户端先发送一个请求，然后服务端读取请求并发送应答，最后客户端读取应答，如此反复。如果客户端或服务端尝试破坏这种约束（例如，连续发送两个请求，而没有等待响应），那么将返回一个错误</li>
<li>我们的代理必须是非阻塞的，可以使用zmq_poll()来轮询任何一个套接字上的活动，但我们不能使用REQ-REQ。幸运地是，有两个称为DEALER和ROUTER的套接字，它们能我们可以执行无阻塞的请求-响应</li>
</ul>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171026324.png" class="" title="image-20230310171026324">
</li>
</ul>
<ul>
<li><strong>代理演示案例如下所示：**</strong>我们扩展了上面的“REQ-REP”演示案例：**REQ和ROUTER交流，DEALER与REP交流。代理节点从一个套接字读取消息，并将消息转发到其他套接字</li>
</ul>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171051462.png" class="" title="image-20230310171051462">
<p><strong>客户端的代码如下：</strong>将REQ套接字连接到代理的ROUTER节点上，向ROUTER节点发送“Hello”，接收到“World”的回复</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rrclient.c</span></span><br><span class="line"><span class="comment">// https://github.com/dongyusheng/csdn-code/blob/master/ZeroMQ/rrclient.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zmq.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 向socket发送数据, 数据为string</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br><span class="line"><span class="comment">// 从socket接收数据, 并将数据以字符串的形式返回</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="comment">// 1.初始化上下文</span></span><br><span class="line">    <span class="type">void</span> *context = zmq_ctx_new();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 2.创建套接字、连接代理的ROUTER端</span></span><br><span class="line">    <span class="type">void</span> *requester = zmq_socket(context, ZMQ_REQ);</span><br><span class="line">    rc = zmq_connect(requester, <span class="string">&quot;tcp://localhost:5559&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;zmq_connect&quot;</span>);</span><br><span class="line">        zmq_close(requester);</span><br><span class="line">        zmq_ctx_destroy(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 3.循环发送、接收数据(10次)</span></span><br><span class="line">    <span class="type">int</span> request_nbr;</span><br><span class="line">    <span class="keyword">for</span>(request_nbr = <span class="number">0</span>; request_nbr &lt; <span class="number">10</span>; request_nbr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4.先发送数据</span></span><br><span class="line">        rc = s_send(requester, <span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(rc &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;s_send&quot;</span>);</span><br><span class="line">            zmq_close(requester);</span><br><span class="line">            zmq_ctx_destroy(context);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.等待响应</span></span><br><span class="line">        <span class="type">char</span> *reply = s_recv(requester);</span><br><span class="line">        <span class="keyword">if</span>(reply == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;s_recv&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(reply);</span><br><span class="line">            zmq_close(requester);</span><br><span class="line">            zmq_ctx_destroy(context);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Reply[%d]: %s\n&quot;</span>, request_nbr + <span class="number">1</span>, reply);</span><br><span class="line">        <span class="built_in">free</span>(reply);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 6.关闭套接字、销毁上下文</span></span><br><span class="line">    zmq_close(requester);</span><br><span class="line">    zmq_ctx_destroy(context);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    </span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init_size(&amp;msg, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(zmq_msg_data(&amp;msg), <span class="built_in">string</span>, <span class="built_in">strlen</span>(<span class="built_in">string</span>));</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_send(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_recv(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span> = (<span class="type">char</span>*)<span class="built_in">malloc</span>(rc + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="built_in">string</span>, zmq_msg_data(&amp;msg), rc);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">string</span>[rc] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>服务端的代码如下：</strong>将REP套接字连接到代理的DEALER节点上</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rrworker.c</span></span><br><span class="line"><span class="comment">// https://github.com/dongyusheng/csdn-code/blob/master/ZeroMQ/rrworker.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zmq.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 向socket发送数据, 数据为string</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br><span class="line"><span class="comment">// 从socket接收数据, 并将数据以字符串的形式返回</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="comment">// 1.初始化上下文</span></span><br><span class="line">    <span class="type">void</span> *context = zmq_ctx_new();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 2.创建套接字、连接代理的DEALER端</span></span><br><span class="line">    <span class="type">void</span> *responder = zmq_socket(context, ZMQ_REP);</span><br><span class="line">    rc = zmq_connect(responder, <span class="string">&quot;tcp://localhost:5560&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;zmq_connect&quot;</span>);</span><br><span class="line">        zmq_close(responder);</span><br><span class="line">        zmq_ctx_destroy(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 3.循环接收、响应</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4.先等待接收数据</span></span><br><span class="line">        <span class="type">char</span> *request = s_recv(responder);</span><br><span class="line">        <span class="keyword">if</span>(request == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;s_recv&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(request);</span><br><span class="line">            zmq_close(responder);</span><br><span class="line">            zmq_ctx_destroy(context);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Request: %s\n&quot;</span>, request);</span><br><span class="line">        <span class="built_in">free</span>(request);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 休眠1秒再进行响应</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.响应</span></span><br><span class="line">        rc = s_send(responder, <span class="string">&quot;World&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(rc &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;s_send&quot;</span>);</span><br><span class="line">            zmq_close(responder);</span><br><span class="line">            zmq_ctx_destroy(context);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 6.关闭套接字、销毁上下文</span></span><br><span class="line">    zmq_close(responder);</span><br><span class="line">    zmq_ctx_destroy(context);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">s_send</span><span class="params">(<span class="type">void</span> *socket, <span class="type">char</span> *<span class="built_in">string</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    </span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init_size(&amp;msg, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(zmq_msg_data(&amp;msg), <span class="built_in">string</span>, <span class="built_in">strlen</span>(<span class="built_in">string</span>));</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_send(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">s_recv</span><span class="params">(<span class="type">void</span> *socket)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">    zmq_msg_init(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    rc = zmq_msg_recv(&amp;msg, socket, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span> = (<span class="type">char</span>*)<span class="built_in">malloc</span>(rc + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="built_in">string</span>, zmq_msg_data(&amp;msg), rc);</span><br><span class="line">    zmq_msg_close(&amp;msg);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">string</span>[rc] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>代理端的代码如下：</strong><ul>
<li>创建一个ROUTER套接字与客户端相连接，创建一个DEALER套接字与服务端相连接</li>
<li>ROUTER套接字从客户端接收请求数据，并把请求数据发送给服务端</li>
<li>DEALER套接字从服务端接收响应数据，并把响应数据发送给客户端</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rrbroker.c</span></span><br><span class="line"><span class="comment">// https://github.com/dongyusheng/csdn-code/blob/master/ZeroMQ/rrbroker.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zmq.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="comment">// 1.初始化上下文</span></span><br><span class="line">    <span class="type">void</span> *context = zmq_ctx_new();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 2.创建、绑定套接字</span></span><br><span class="line">    <span class="type">void</span> *frontend = zmq_socket(context, ZMQ_ROUTER);</span><br><span class="line">    <span class="type">void</span> *backend = zmq_socket(context, ZMQ_DEALER);</span><br><span class="line">    <span class="comment">// ZMQ_ROUTER绑定到5559, 接收客户端的请求</span></span><br><span class="line">    rc = zmq_bind(frontend, <span class="string">&quot;tcp://*:5559&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;zmq_bind&quot;</span>);</span><br><span class="line">        zmq_close(frontend);</span><br><span class="line">        zmq_close(backend);</span><br><span class="line">        zmq_ctx_destroy(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ZMQ_DEALER绑定到5560, 接收服务端的回复</span></span><br><span class="line">    rc = zmq_bind(backend, <span class="string">&quot;tcp://*:5560&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(rc == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;zmq_bind&quot;</span>);</span><br><span class="line">        zmq_close(frontend);</span><br><span class="line">        zmq_close(backend);</span><br><span class="line">        zmq_ctx_destroy(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.初始化轮询集合</span></span><br><span class="line">    <span class="type">zmq_pollitem_t</span> items[] = &#123;</span><br><span class="line">        &#123; frontend, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; backend, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 4.在套接字上切换消息</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">zmq_msg_t</span> msg;</span><br><span class="line">        <span class="comment">//多部分消息检测</span></span><br><span class="line">        <span class="type">int</span> more;     </span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 5.调用zmq_poll轮询消息</span></span><br><span class="line">        rc = zmq_poll(items, <span class="number">2</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="comment">//zmq_poll出错</span></span><br><span class="line">        <span class="keyword">if</span>(rc == <span class="number">-1</span>)     </span><br><span class="line">        &#123;</span><br><span class="line">             perror(<span class="string">&quot;zmq_poll&quot;</span>);</span><br><span class="line">            zmq_close(frontend);</span><br><span class="line">            zmq_close(backend);</span><br><span class="line">            zmq_ctx_destroy(context);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//zmq_poll超时</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(rc == <span class="number">0</span>) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 6.如果ROUTER套接字有数据来</span></span><br><span class="line">            <span class="keyword">if</span>(items[<span class="number">0</span>].revents &amp; ZMQ_POLLIN)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 从ROUTER上接收数据, 这么数据是客户端发送过来的&quot;Hello&quot;</span></span><br><span class="line">                    zmq_msg_init(&amp;msg);</span><br><span class="line">                    zmq_msg_recv(&amp;msg, frontend, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// 查看是否是接收多部分消息, 如果后面还有数据要接收, 那么more会被置为1</span></span><br><span class="line">                    <span class="type">size_t</span> more_size = <span class="keyword">sizeof</span>(more);</span><br><span class="line">                    zmq_getsockopt(frontend, ZMQ_RCVMORE, &amp;more, &amp;more_size);</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// 接收&quot;Hello&quot;之后, 将数据发送到DEALER上, DEALER会将&quot;Hello&quot;发送给服务端</span></span><br><span class="line">                    zmq_msg_send(&amp;msg, backend, more ? ZMQ_SNDMORE : <span class="number">0</span>);</span><br><span class="line">                    zmq_msg_close(&amp;msg);</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// 如果没有多部分数据可以接收了, 那么退出循环</span></span><br><span class="line">                    <span class="keyword">if</span>(!more)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 7.如果DEALER套接字有数据来</span></span><br><span class="line">            <span class="keyword">if</span>(items[<span class="number">1</span>].revents &amp; ZMQ_POLLIN)</span><br><span class="line">            &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 接收服务端的响应&quot;World&quot;</span></span><br><span class="line">                    zmq_msg_init(&amp;msg);</span><br><span class="line">                    zmq_msg_recv(&amp;msg, backend, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// 查看是否是接收多部分消息, 如果后面还有数据要接收, 那么more会被置为1</span></span><br><span class="line">                    <span class="type">size_t</span> more_size = <span class="keyword">sizeof</span>(more);</span><br><span class="line">                    zmq_getsockopt(backend, ZMQ_RCVMORE, &amp;more, &amp;more_size);</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// 接收&quot;World&quot;之后, 将数据发送到ROUTER上, ROUTER会将&quot;World&quot;发送给客户端</span></span><br><span class="line">                    zmq_msg_send(&amp;msg, frontend, more ? ZMQ_SNDMORE : <span class="number">0</span>);</span><br><span class="line">                    zmq_msg_close(&amp;msg);</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// 如果没有多部分数据可以接收了, 那么退出循环</span></span><br><span class="line">                    <span class="keyword">if</span>(!more)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 8.关闭套接字、销毁上下文</span></span><br><span class="line">    zmq_close(frontend);</span><br><span class="line">    zmq_close(backend);</span><br><span class="line">    zmq_ctx_destroy(context);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o rrclient rrclient.c -lzmq</span><br><span class="line">gcc -o rrworker rrworker.c -lzmq</span><br><span class="line">gcc -o rrbroker rrbroker.c -lzmq</span><br></pre></td></tr></table></figure>
<p><strong>一次运行如下，</strong>左侧为客户端，中间为代理，右侧为服务端</p>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171239149.png" class="" title="image-20230310171239149">
<p><strong>下面运行两个客户端，</strong>0为代理，1、2为客户端，3位服务端。可以看到客户端的消息是有顺序到达客户端的，消息会自动进行排队</p>
<img src="/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/image-20230310171259512.png" class="" title="image-20230310171259512">
<p>————————————————<br>版权声明：本文为CSDN博主「董哥的黑板报」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/106878960">https://blog.csdn.net/qq_41453285/article/details/106878960</a></p>
<p>————————————————<br>版权声明：本文为CSDN博主「董哥的黑板报」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/106878960">https://blog.csdn.net/qq_41453285/article/details/106878960</a></p>
<p>————————————————<br>版权声明：本文为CSDN博主「董哥的黑板报」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/106878960">https://blog.csdn.net/qq_41453285/article/details/106878960</a></p>
<p>————————————————<br>版权声明：本文为CSDN博主「董哥的黑板报」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/106878960">https://blog.csdn.net/qq_41453285/article/details/106878960</a></p>
<h1 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h1><ol>
<li>关于bind和connect：例如pub和sub示例1，并不是pub必须调用bind，sub一定调用connect。实际是根据那一端是服务端（也就是单独的），那一端是客户端（多数的）来决定的。总是服务端调用bind，客户端调用connnect。</li>
</ol>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>比较新的中文参考</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34854320/article/details/112983028">https://blog.csdn.net/weixin_34854320/article/details/112983028</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/neooelric/p/9020872.html">https://www.cnblogs.com/neooelric/p/9020872.html</a></p>
<p>较旧的中文参考就是zmq中文目录下的内容</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dongyusheng/csdn-code/">https://github.com/dongyusheng/csdn-code/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/category_9981784.html">https://blog.csdn.net/qq_41453285/category_9981784.html</a></p>
<p>官方说明：<a target="_blank" rel="noopener" href="https://zguide.zeromq.org/docs/chapter1/">https://zguide.zeromq.org/docs/chapter1/</a></p>
<p>官方API：<a target="_blank" rel="noopener" href="http://api.zeromq.org/">http://api.zeromq.org/</a></p>
<p>博客 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41453285/article/details/106865539">https://blog.csdn.net/qq_41453285/article/details/106865539</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>奔跑的IC
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/zeromq/4%20ZMQ%E8%AF%B7%E6%B1%82-%E5%BA%94%E7%AD%94%E6%A8%A1%E5%BC%8F/" title="4 ZMQ请求-应答模式">http://example.com/zeromq/4 ZMQ请求-应答模式/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/git/" rel="tag"><i class="fa fa-tag"></i> git</a>
              <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C</a>
              <a href="/tags/zmq/" rel="tag"><i class="fa fa-tag"></i> zmq</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E7%BC%96%E7%A8%8B/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/" rel="prev" title="软件架构">
                  <i class="fa fa-chevron-left"></i> 软件架构
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">奔跑的IC</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"zmurder","repo":"zmurder.github.io","client_id":"cf2343f27b6c29efe0bc","client_secret":"3268a1fa92706c7358d5421f88f76a0f7ada3188","admin_user":"zmurder","distraction_free_mode":true,"proxy":"https://strong-caramel-969805.netlify.app/github_access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"3b4744a94033d66257e743e08118a9b2"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
